# Redis Schema Core Patterns - Soins Suite

## ğŸ¯ Objectif

DÃ©finir les **conventions de base strictes** pour toutes les clÃ©s Redis du projet selon les standards du fichier `conventions.md`.

## ğŸ“‹ Convention Obligatoire Multi-Tenant

### **Format Standard Unique**

```
soins_suite_{code_etablissement}_{domain}_{context}:{identifier}
```

### **Exemples Conformes**

```
soins_suite_CENTREA_cache_middleware:establishment
soins_suite_HOPITAL_cache_middleware:establishment
soins_suite_CLINIQUE_auth_session:user_123
```

## ğŸ”§ Structure des Composants

1. **`soins_suite`** - Namespace fixe du projet
2. **`{code_etablissement}`** - Code Ã©tablissement (3-20 chars, majuscules, alphanumÃ©riques)
3. **`{domain}`** - Domaine fonctionnel : `auth`, `cache`, `setup`
4. **`{context}`** - Contexte spÃ©cifique : `session`, `license`, `middleware`, etc.
5. **`{identifier}`** - Identifiant unique ou vide pour singletons

## âš ï¸ RÃ¨gles Strictes

### **âŒ INTERDIT**
- ClÃ©s sans code Ã©tablissement (violation isolation multi-tenant)
- ClÃ©s sans prÃ©fixe `soins_suite_`
- Utilisation d'espaces dans les clÃ©s
- CaractÃ¨res spÃ©ciaux (seuls autorisÃ©s : `:`, `_`, `-`)
- ClÃ©s de plus de 250 caractÃ¨res
- Hardcoder des clÃ©s dans le code

### **âœ… OBLIGATOIRE**
- Toujours utiliser le pattern multi-tenant
- Code Ã©tablissement valide (3-20 chars, alphanumÃ©riques majuscules)
- Validation automatique via `ValidateKey()`
- Documentation prÃ©alable dans les fichiers `*.md`

## ğŸ•’ TTL Standards par Type

| Type de donnÃ©es | TTL suggÃ©rÃ© | Justification |
|-----------------|-------------|---------------|
| **Sessions utilisateur** | 3600s (1h) | Ã‰quilibre sÃ©curitÃ©/UX |
| **Cache middleware** | 900s (15min) | DonnÃ©es critiques, refresh frÃ©quent |
| **Cache mÃ©tier** | 1800s (30min) | Compromise performance/fraÃ®cheur |
| **Ã‰tats temporaires** | 7200s (2h) | Process longs (setup, etc.) |

**Note** : Les TTL exacts seront dÃ©finis lors de l'implÃ©mentation de chaque clÃ© selon les besoins spÃ©cifiques.

## ğŸ’¡ Exemple d'Usage Correct

### **Pattern Multi-Tenant dans le Code**

```go
// âœ… CORRECT - Utilisation conforme aux conventions
func (s *MyService) CacheData(ctx context.Context, establishmentCode string, data interface{}) error {
    // Exemple avec la clÃ© implÃ©mentÃ©e : soins_suite_{etablissement}_cache_middleware:establishment
    return s.redisClient.SetWithPattern(ctx, "cache_middleware", establishmentCode, data, "establishment")
}

// âœ… CORRECT - RÃ©cupÃ©ration avec validation automatique
func (s *MyService) GetCachedData(ctx context.Context, establishmentCode string) (string, error) {
    return s.redisClient.GetWithPattern(ctx, "cache_middleware", establishmentCode, "establishment")
}
```

### **âŒ Anti-Patterns Ã  Ã‰viter**

```go
// âŒ INTERDIT - ClÃ© hardcodÃ©e non multi-tenant
key := "cache:establishment:data"

// âŒ INTERDIT - Pas d'isolation par Ã©tablissement  
key := fmt.Sprintf("soins_suite_cache_middleware:%s", dataType)

// âŒ INTERDIT - CrÃ©ation manuelle de clÃ©
s.redisClient.Set(ctx, "my-custom-key", data, time.Hour)
```

## ğŸ”— RÃ©fÃ©rences

- **Helpers type-safe** : Voir `internal/shared/utils/redis_keys.go`
- **Documentation dÃ©taillÃ©e** : Consulter les fichiers `01.*.md`, `02.*.md`, etc.
- **Validation** : Toutes les clÃ©s sont validÃ©es automatiquement

---

**ğŸ“ Rappel** : Ce fichier contient uniquement les **conventions gÃ©nÃ©rales**. Pour des clÃ©s spÃ©cifiques, consulter les fichiers de documentation par domaine.
