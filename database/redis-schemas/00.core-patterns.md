# Redis Schema Core Patterns - Soins Suite

## 🎯 Objectif

Définir les **conventions de base strictes** pour toutes les clés Redis du projet selon les standards du fichier `conventions.md`.

## 📋 Convention Obligatoire Multi-Tenant

### **Format Standard Unique**

```
soins_suite_{code_etablissement}_{domain}_{context}:{identifier}
```

### **Exemples Conformes**

```
soins_suite_CENTREA_cache_middleware:establishment
soins_suite_HOPITAL_cache_middleware:establishment
soins_suite_CLINIQUE_auth_session:user_123
```

## 🔧 Structure des Composants

1. **`soins_suite`** - Namespace fixe du projet
2. **`{code_etablissement}`** - Code établissement (3-20 chars, majuscules, alphanumériques)
3. **`{domain}`** - Domaine fonctionnel : `auth`, `cache`, `setup`
4. **`{context}`** - Contexte spécifique : `session`, `license`, `middleware`, etc.
5. **`{identifier}`** - Identifiant unique ou vide pour singletons

## ⚠️ Règles Strictes

### **❌ INTERDIT**
- Clés sans code établissement (violation isolation multi-tenant)
- Clés sans préfixe `soins_suite_`
- Utilisation d'espaces dans les clés
- Caractères spéciaux (seuls autorisés : `:`, `_`, `-`)
- Clés de plus de 250 caractères
- Hardcoder des clés dans le code

### **✅ OBLIGATOIRE**
- Toujours utiliser le pattern multi-tenant
- Code établissement valide (3-20 chars, alphanumériques majuscules)
- Validation automatique via `ValidateKey()`
- Documentation préalable dans les fichiers `*.md`

## 🕒 TTL Standards par Type

| Type de données | TTL suggéré | Justification |
|-----------------|-------------|---------------|
| **Sessions utilisateur** | 3600s (1h) | Équilibre sécurité/UX |
| **Cache middleware** | 900s (15min) | Données critiques, refresh fréquent |
| **Cache métier** | 1800s (30min) | Compromise performance/fraîcheur |
| **États temporaires** | 7200s (2h) | Process longs (setup, etc.) |

**Note** : Les TTL exacts seront définis lors de l'implémentation de chaque clé selon les besoins spécifiques.

## 💡 Exemple d'Usage Correct

### **Pattern Multi-Tenant dans le Code**

```go
// ✅ CORRECT - Utilisation conforme aux conventions
func (s *MyService) CacheData(ctx context.Context, establishmentCode string, data interface{}) error {
    // Exemple avec la clé implémentée : soins_suite_{etablissement}_cache_middleware:establishment
    return s.redisClient.SetWithPattern(ctx, "cache_middleware", establishmentCode, data, "establishment")
}

// ✅ CORRECT - Récupération avec validation automatique
func (s *MyService) GetCachedData(ctx context.Context, establishmentCode string) (string, error) {
    return s.redisClient.GetWithPattern(ctx, "cache_middleware", establishmentCode, "establishment")
}
```

### **❌ Anti-Patterns à Éviter**

```go
// ❌ INTERDIT - Clé hardcodée non multi-tenant
key := "cache:establishment:data"

// ❌ INTERDIT - Pas d'isolation par établissement  
key := fmt.Sprintf("soins_suite_cache_middleware:%s", dataType)

// ❌ INTERDIT - Création manuelle de clé
s.redisClient.Set(ctx, "my-custom-key", data, time.Hour)
```

## 🔗 Références

- **Helpers type-safe** : Voir `internal/shared/utils/redis_keys.go`
- **Documentation détaillée** : Consulter les fichiers `01.*.md`, `02.*.md`, etc.
- **Validation** : Toutes les clés sont validées automatiquement

---

**📍 Rappel** : Ce fichier contient uniquement les **conventions générales**. Pour des clés spécifiques, consulter les fichiers de documentation par domaine.
