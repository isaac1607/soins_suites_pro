# SP√âCIFICATIONS TECHNIQUES - MODULE GESTION UTILISATEURS - RUBRIQUE GESTION_GROUPES

## üìã Informations G√©n√©rales

- **Module :** Gestion des Utilisateurs (Back-Office)
- **Rubrique :** GESTION_GROUPES
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Services ‚Üí Queries ‚Üí DB (PostgreSQL)

## üéØ Objectif

D√©velopper un syst√®me complet de gestion des groupes/profils m√©tier permettant :

- CRUD complet des profils templates avec permissions pr√©d√©finies
- Attribution en masse de permissions via profils
- Gestion flexible modules complets ou rubriques sp√©cifiques
- Association/dissociation d'utilisateurs aux profils
- Import/Export de profils types entre √©tablissements

## üèóÔ∏è Architecture Technique

```
internal/modules/back-office/users/
‚îú‚îÄ‚îÄ users.module.go                    # Module Fx
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.controller.go      # CRUD profils/groupes
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.service.go         # Logique groupes
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.dto.go            # DTOs groupes
‚îî‚îÄ‚îÄ queries/
    ‚îî‚îÄ‚îÄ groupes/
        ‚îî‚îÄ‚îÄ groupes.postgres.go        # Requ√™tes SQL natives
```

---

## üîß US-GG-001 : Liste des Profils/Groupes

### **GET /api/v1/back-office/profils**

#### **R√®gles M√©tier**

1. **Filtrage multi-crit√®res** : Par statut, type, nombre d'utilisateurs
2. **Pagination obligatoire** : Limite max 100 enregistrements par page
3. **Tri par d√©faut** : Par nom_profil croissant
4. **Statistiques incluses** : Nombre d'utilisateurs et modules par profil
5. **Profils pr√©d√©finis** : Marquage sp√©cial pour profils syst√®me non modifiables
6. **Isolation √©tablissement** : Profils isol√©s par etablissement_id

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre      | Type    | D√©faut     | Description                       |
| -------------- | ------- | ---------- | --------------------------------- |
| page           | integer | 1          | Num√©ro de page                    |
| limit          | integer | 20         | Nombre d'√©l√©ments (max: 100)      |
| search         | string  | -          | Recherche dans nom et description |
| est_actif      | boolean | true       | Filtrer profils actifs/inactifs   |
| est_predefinit | boolean | -          | Filtrer profils syst√®me           |
| sort_by        | string  | nom_profil | nom_profil, created_at, nb_users  |
| sort_order     | string  | asc        | asc ou desc                       |
| include_stats  | boolean | true       | Inclure statistiques d'usage      |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "profils": [
      {
        "id": "profil-uuid",
        "code_profil": "MEDECIN",
        "nom_profil": "M√©decins",
        "description": "Profil pour les m√©decins de l'√©tablissement",
        "est_predefinit": false,
        "est_actif": true,
        "statistiques": {
          "nombre_utilisateurs": 25,
          "nombre_utilisateurs_actifs": 23,
          "nombre_modules": 8,
          "nombre_modules_complets": 6,
          "nombre_rubriques_specifiques": 12
        },
        "created_at": "2025-01-01T10:00:00Z",
        "updated_at": "2025-01-10T10:00:00Z",
        "created_by": {
          "id": "admin-uuid",
          "nom": "Admin",
          "prenoms": "System"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 12,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    },
    "resume": {
      "total_profils": 12,
      "profils_actifs": 10,
      "profils_predefinits": 3,
      "total_utilisateurs_affectes": 150
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Performance** : Utilisation d'index sur (etablissement_id, est_actif, nom_profil)
- **Statistiques conditionnelles** : Calcul√©es uniquement si include_stats=true
- **Profils pr√©d√©finis** : Non supprimables, modifications limit√©es
- **Isolation stricte** : Aucune fuite entre √©tablissements

---

## üîß US-GG-002 : D√©tails d'un Profil

### **GET /api/v1/back-office/profils/{id}**

#### **R√®gles M√©tier**

1. **Donn√©es compl√®tes** : Profil + permissions + utilisateurs associ√©s
2. **Permissions structur√©es** : Modules complets vs rubriques sp√©cifiques
3. **Liste utilisateurs** : Pagin√©e si > 20 utilisateurs
4. **Historique modifications** : Derni√®res modifications du profil
5. **Validation existence** : Erreur 404 si profil inexistant

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre     | Type    | D√©faut | Description                    |
| ------------- | ------- | ------ | ------------------------------ |
| include_users | boolean | true   | Inclure liste utilisateurs     |
| users_page    | integer | 1      | Page pour liste utilisateurs   |
| users_limit   | integer | 20     | Limite utilisateurs (max: 100) |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "profil": {
      "id": "profil-uuid",
      "code_profil": "MEDECIN",
      "nom_profil": "M√©decins",
      "description": "Profil pour les m√©decins de l'√©tablissement",
      "est_predefinit": false,
      "est_actif": true,
      "created_at": "2025-01-01T10:00:00Z",
      "updated_at": "2025-01-10T10:00:00Z",
      "created_by": {
        "id": "admin-uuid",
        "nom": "Admin",
        "prenoms": "System"
      }
    },
    "permissions": {
      "modules_complets": [
        {
          "id": "module-uuid",
          "code_module": "CONSULTATION",
          "nom_standard": "Consultation",
          "nom_personnalise": null,
          "description": "Module de consultation m√©dicale",
          "peut_prendre_ticket": true,
          "est_medical": true,
          "date_attribution": "2025-01-01T10:00:00Z"
        }
      ],
      "modules_avec_rubriques": [
        {
          "id": "module-urgences-uuid",
          "code_module": "URGENCES",
          "nom_standard": "Urgences",
          "rubriques": [
            {
              "id": "rubrique-uuid",
              "code_rubrique": "TRIAGE",
              "nom": "Triage urgences",
              "description": "Gestion du triage",
              "ordre_affichage": 1
            }
          ],
          "date_attribution": "2025-01-05T10:00:00Z"
        }
      ]
    },
    "utilisateurs": {
      "liste": [
        {
          "id": "user-uuid",
          "identifiant": "john.doe",
          "nom": "DOE",
          "prenoms": "John",
          "est_medecin": true,
          "role_metier": "M√©decin g√©n√©raliste",
          "statut": "actif",
          "date_attribution": "2025-01-05T10:00:00Z",
          "attribue_par": {
            "id": "admin-uuid",
            "nom": "Admin",
            "prenoms": "RH"
          }
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 20,
        "total": 25,
        "total_pages": 2
      }
    },
    "statistiques": {
      "total_modules": 8,
      "modules_complets": 6,
      "modules_avec_rubriques": 2,
      "total_rubriques": 5,
      "total_utilisateurs": 25,
      "utilisateurs_actifs": 23,
      "derniere_attribution": "2025-01-14T10:00:00Z"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Jointures optimis√©es** : Eager loading pour √©viter N+1 queries
- **Pagination utilisateurs** : Obligatoire si > 20 utilisateurs
- **Permissions group√©es** : S√©paration modules complets vs partiels
- **Tri utilisateurs** : Par date attribution d√©croissante

---

## üîß US-GG-003 : Cr√©ation d'un Profil

### **POST /api/v1/back-office/profils**

#### **R√®gles M√©tier**

1. **Code unique** : Validation unicit√© par √©tablissement
2. **Modules autoris√©s** : V√©rification contre base_licence.modules_autorises
3. **Coh√©rence permissions** : Module requis pour attribuer ses rubriques
4. **Transaction atomique** : Profil + modules + rubriques en une transaction
5. **Profils front-office uniquement** : Modules avec est_module_back_office = false
6. **Attribution initiale** : Possibilit√© d'ajouter des utilisateurs √† la cr√©ation

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Format des Champs pour le Front-End**

> **üìã Convention de Documentation :**
>
> - **Champs sans commentaire** = **OBLIGATOIRES**
> - **Champs avec `// OPTIONNEL`** = **FACULTATIFS**
> - **Champs conditionnels** = **OBLIGATOIRES sous certaines conditions** (pr√©cis√©es dans le commentaire)

#### **Request Body**

```json
{
  "code_profil": "INFIRMIER",
  "nom_profil": "Infirmiers",
  "description": "Profil pour le personnel infirmier", // OPTIONNEL
  "modules_attribues": [
    {
      "module_id": "module-soins-uuid",
      "acces_toutes_rubriques": true,
      "rubriques_specifiques": [] // Ignor√© si acces_toutes_rubriques = true
    },
    {
      "module_id": "module-dossier-patient-uuid",
      "acces_toutes_rubriques": false,
      "rubriques_specifiques": [
        "rubrique-signes-vitaux-uuid",
        "rubrique-soins-uuid"
      ] // OBLIGATOIRE si acces_toutes_rubriques = false
    }
  ],
  "utilisateurs_ids": ["user-uuid-1", "user-uuid-2"], // OPTIONNEL - attribution initiale
  "est_actif": true
}
```

#### **R√®gles de Validation**

| Champ                                        | Type    | Obligatoire | Validation                                 | Description                        |
| -------------------------------------------- | ------- | ----------- | ------------------------------------------ | ---------------------------------- |
| `code_profil`                                | string  | ‚úÖ          | 3-50 caract√®res, alphanum√©rique majuscules | Code unique par √©tablissement      |
| `nom_profil`                                 | string  | ‚úÖ          | 2-255 caract√®res                           | Nom affich√© du profil              |
| `description`                                | string  | ‚ùå          | Max 1000 caract√®res                        | Description d√©taill√©e              |
| `modules_attribues`                          | array   | ‚úÖ          | Au moins 1 module                          | Liste des modules avec permissions |
| `modules_attribues[].module_id`              | string  | ‚úÖ          | UUID valide, module autoris√©               | ID du module                       |
| `modules_attribues[].acces_toutes_rubriques` | boolean | ‚úÖ          | -                                          | Acc√®s complet ou partiel           |
| `modules_attribues[].rubriques_specifiques`  | array   | üîÑ          | UUIDs valides                              | Requis si acc√®s partiel            |
| `utilisateurs_ids`                           | array   | ‚ùå          | UUIDs valides, utilisateurs actifs         | Attribution initiale               |
| `est_actif`                                  | boolean | ‚úÖ          | -                                          | Statut du profil                   |

**L√©gende :**

- ‚úÖ **Obligatoire** : Champ requis dans tous les cas
- ‚ùå **Optionnel** : Champ facultatif
- üîÑ **Conditionnel** : Obligatoire selon le contexte

#### **Response 201**

```json
{
  "success": true,
  "data": {
    "id": "new-profil-uuid",
    "code_profil": "INFIRMIER",
    "nom_profil": "Infirmiers",
    "message": "Profil cr√©√© avec succ√®s",
    "permissions_attribuees": {
      "modules_complets": 1,
      "modules_avec_rubriques": 1,
      "total_rubriques": 2
    },
    "utilisateurs_affectes": 2,
    "created_at": "2025-01-15T10:00:00Z",
    "created_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **Response 400 - Validation Error**

```json
{
  "error": "Erreur de validation",
  "details": {
    "code": "VALIDATION_ERROR",
    "champs": {
      "code_profil": "Ce code profil existe d√©j√†",
      "modules_attribues[0].module_id": "Module non autoris√© par la licence",
      "modules_attribues[1].rubriques_specifiques": "Rubriques requises pour acc√®s partiel"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Validation modules** : V√©rification contre base_licence.modules_autorises JSONB
- **Modules front-office** : Seuls modules avec est_module_back_office = false
- **Coh√©rence rubriques** : Rubriques doivent appartenir au module parent
- **Attribution utilisateurs** : En transaction avec cr√©ation profil
- **Audit complet** : Enregistrement created_by automatique

---

## üîß US-GG-004 : Modification d'un Profil

### **PUT /api/v1/back-office/profils/{id}**

#### **R√®gles M√©tier**

1. **Modification partielle** : Seuls les champs fournis sont modifi√©s
2. **Profils pr√©d√©finis** : Modifications limit√©es (nom et description uniquement)
3. **Impact imm√©diat** : Changements appliqu√©s √† tous les utilisateurs du profil
4. **Validation modules** : V√©rification licence pour nouveaux modules
5. **Historique pr√©serv√©** : Tra√ßabilit√© des modifications

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "nom_profil": "Infirmiers - Service Urgences", // OPTIONNEL
  "description": "Profil sp√©cialis√© pour les urgences", // OPTIONNEL
  "est_actif": true, // OPTIONNEL
  "modules_a_ajouter": [
    // OPTIONNEL
    {
      "module_id": "module-urgences-uuid",
      "acces_toutes_rubriques": true
    }
  ],
  "modules_a_modifier": [
    // OPTIONNEL
    {
      "module_id": "module-dossier-patient-uuid",
      "acces_toutes_rubriques": false,
      "rubriques_specifiques": ["rubrique-triage-uuid"]
    }
  ],
  "modules_a_retirer": ["module-laboratoire-uuid"] // OPTIONNEL
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "id": "profil-uuid",
    "message": "Profil modifi√© avec succ√®s",
    "changements": {
      "champs_modifies": ["nom_profil", "description"],
      "modules_ajoutes": 1,
      "modules_modifies": 1,
      "modules_retires": 1,
      "utilisateurs_impactes": 25
    },
    "updated_at": "2025-01-15T15:30:00Z",
    "updated_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **Response 403 - Profil Pr√©d√©fini**

```json
{
  "error": "Modification limit√©e",
  "details": {
    "code": "PREDEFINED_PROFILE_RESTRICTION",
    "message": "Les profils pr√©d√©finis ne peuvent √™tre modifi√©s que partiellement",
    "champs_autorises": ["nom_profil", "description"]
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Profils pr√©d√©finis** : est_predefinit = true ‚Üí modifications limit√©es
- **Impact cascade** : Recalcul permissions tous les utilisateurs
- **Transaction PostgreSQL** : ROLLBACK si erreur
- **Validation coh√©rence** : Module requis pour ses rubriques
- **Notification optionnelle** : Informer utilisateurs impact√©s

---

## üîß US-GG-005 : Suppression d'un Profil

### **DELETE /api/v1/back-office/profils/{id}**

#### **R√®gles M√©tier**

1. **Suppression conditionnelle** : Impossible si utilisateurs associ√©s
2. **Profils pr√©d√©finis** : Non supprimables
3. **Alternative soft delete** : D√©sactivation via PUT est_actif = false
4. **Cascade permissions** : Suppression user_profil_modules et user_profil_rubriques
5. **Transaction atomique** : Tout ou rien

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200 - Succ√®s**

```json
{
  "success": true,
  "data": {
    "id": "profil-uuid",
    "message": "Profil supprim√© avec succ√®s",
    "modules_dissocies": 5,
    "rubriques_dissociees": 12,
    "deleted_at": "2025-01-15T15:30:00Z",
    "deleted_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **Response 400 - Utilisateurs Associ√©s**

```json
{
  "error": "Suppression impossible",
  "details": {
    "code": "PROFILE_HAS_USERS",
    "message": "Ce profil ne peut √™tre supprim√© car des utilisateurs y sont associ√©s",
    "nombre_utilisateurs": 25,
    "suggestion": "D√©sactivez le profil ou retirez d'abord tous les utilisateurs"
  }
}
```

#### **Response 403 - Profil Pr√©d√©fini**

```json
{
  "error": "Suppression interdite",
  "details": {
    "code": "PREDEFINED_PROFILE",
    "message": "Les profils pr√©d√©finis ne peuvent pas √™tre supprim√©s"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **V√©rification pr√©alable** : COUNT sur user_profil_utilisateurs
- **Cascade automatique** : DELETE CASCADE sur tables li√©es
- **Audit trail** : Enregistrement suppression
- **Alternative recommand√©e** : D√©sactivation plut√¥t que suppression

---

## üîß US-GG-006 : Attribution d'Utilisateurs √† un Profil

### **POST /api/v1/back-office/profils/{id}/users**

#### **R√®gles M√©tier**

1. **Attribution en masse** : Plusieurs utilisateurs en une transaction
2. **Validation utilisateurs** : V√©rification existence et statut actif
3. **D√©tection doublons** : Ignorer si d√©j√† attribu√©
4. **Tra√ßabilit√©** : Enregistrement attribue_par et date_attribution
5. **Impact imm√©diat** : Permissions effectives d√®s attribution

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "utilisateurs_ids": ["user-uuid-1", "user-uuid-2", "user-uuid-3"],
  "notifier_utilisateurs": true // OPTIONNEL
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "profil_id": "profil-uuid",
    "profil_nom": "M√©decins",
    "resultats": {
      "utilisateurs_ajoutes": 2,
      "utilisateurs_deja_presents": 1,
      "utilisateurs_invalides": 0,
      "total_traites": 3
    },
    "details": [
      {
        "utilisateur_id": "user-uuid-1",
        "identifiant": "john.doe",
        "statut": "ajout√©",
        "message": "Attribution r√©ussie"
      },
      {
        "utilisateur_id": "user-uuid-2",
        "identifiant": "jane.smith",
        "statut": "ajout√©",
        "message": "Attribution r√©ussie"
      },
      {
        "utilisateur_id": "user-uuid-3",
        "identifiant": "bob.martin",
        "statut": "d√©j√† pr√©sent",
        "message": "Utilisateur d√©j√† associ√© √† ce profil"
      }
    ],
    "notifications": {
      "envoyees": true,
      "nombre": 2
    },
    "attributed_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    },
    "attributed_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Validation pr√©alable** : V√©rifier tous les UUIDs existent
- **Insertion batch** : INSERT multiple optimis√©
- **Gestion doublons** : ON CONFLICT DO NOTHING
- **Notification conditionnelle** : Email si demand√©
- **Limite batch** : Max 100 utilisateurs par requ√™te

---

## üîß US-GG-007 : Retrait d'Utilisateurs d'un Profil

### **DELETE /api/v1/back-office/profils/{id}/users/{user_id}**

#### **R√®gles M√©tier**

1. **Retrait unitaire** : Un utilisateur √† la fois
2. **Impact permissions** : Perte des permissions du profil
3. **V√©rification existence** : 404 si association inexistante
4. **Soft delete** : Mise √† jour est_actif = false
5. **Historique pr√©serv√©** : Conservation pour audit

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "profil_id": "profil-uuid",
    "profil_nom": "M√©decins",
    "utilisateur_id": "user-uuid",
    "utilisateur_identifiant": "john.doe",
    "message": "Utilisateur retir√© du profil avec succ√®s",
    "permissions_perdues": {
      "modules": 5,
      "rubriques": 12
    },
    "removed_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    },
    "removed_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **Response 404 - Association Inexistante**

```json
{
  "error": "Association non trouv√©e",
  "details": {
    "code": "USER_PROFILE_NOT_FOUND",
    "message": "Cet utilisateur n'est pas associ√© √† ce profil"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Soft delete** : UPDATE est_actif = false, date_fin = NOW()
- **Impact calcul** : Recalcul permissions effectives utilisateur
- **Audit complet** : Qui, quand, pourquoi
- **Transaction** : Avec recalcul permissions

---

## üîß US-GG-008 : Retrait en Masse d'un Profil

### **DELETE /api/v1/back-office/profils/{id}/users**

#### **R√®gles M√©tier**

1. **Suppression en masse** : Retrait de plusieurs utilisateurs
2. **Confirmation requise** : Protection contre suppression accidentelle
3. **Impact majeur** : Perte permissions pour tous les utilisateurs
4. **Transaction unique** : Atomicit√© garantie
5. **Rapport d√©taill√©** : Liste des utilisateurs impact√©s

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "utilisateurs_ids": ["user-uuid-1", "user-uuid-2", "user-uuid-3"],
  "confirmation": true,
  "motif": "R√©organisation des √©quipes" // OPTIONNEL
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "profil_id": "profil-uuid",
    "profil_nom": "M√©decins",
    "resultats": {
      "utilisateurs_retires": 3,
      "utilisateurs_non_trouves": 0,
      "total_traites": 3
    },
    "details": [
      {
        "utilisateur_id": "user-uuid-1",
        "identifiant": "john.doe",
        "statut": "retir√©",
        "permissions_perdues": 8
      }
    ],
    "motif": "R√©organisation des √©quipes",
    "removed_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    },
    "removed_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **Response 400 - Confirmation Manquante**

```json
{
  "error": "Confirmation requise",
  "details": {
    "code": "CONFIRMATION_REQUIRED",
    "message": "Le retrait en masse n√©cessite une confirmation explicite",
    "nombre_utilisateurs_impactes": 3
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Confirmation obligatoire** : confirmation = true requis
- **Batch update** : UPDATE en masse est_actif = false
- **Limite batch** : Max 100 utilisateurs
- **Audit d√©taill√©** : Un log par utilisateur retir√©
- **Notification optionnelle** : Informer les utilisateurs

---

## üîß US-GG-009 : Duplication d'un Profil

### **POST /api/v1/back-office/profils/{id}/duplicate**

#### **R√®gles M√©tier**

1. **Copie compl√®te** : Profil + modules + rubriques
2. **Nouveau code** : G√©n√©ration automatique ou fourni
3. **Sans utilisateurs** : Profil vide √† la cr√©ation
4. **Personnalisation** : Possibilit√© de modifier avant cr√©ation
5. **Transaction atomique** : Cr√©ation compl√®te ou √©chec

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "nouveau_code_profil": "INFIRMIER_URGENCES", // OPTIONNEL - g√©n√©r√© si absent
  "nouveau_nom_profil": "Infirmiers Urgences",
  "nouvelle_description": "Profil sp√©cialis√© pour le service des urgences", // OPTIONNEL
  "modifications": {
    // OPTIONNEL - modifications √† appliquer
    "modules_a_exclure": ["module-laboratoire-uuid"],
    "modules_a_ajouter": [
      {
        "module_id": "module-urgences-avance-uuid",
        "acces_toutes_rubriques": true
      }
    ]
  },
  "est_actif": true
}
```

#### **Response 201**

```json
{
  "success": true,
  "data": {
    "profil_original": {
      "id": "profil-uuid",
      "nom": "Infirmiers"
    },
    "nouveau_profil": {
      "id": "new-profil-uuid",
      "code_profil": "INFIRMIER_URGENCES",
      "nom_profil": "Infirmiers Urgences",
      "message": "Profil dupliqu√© avec succ√®s"
    },
    "permissions_copiees": {
      "modules_complets": 4,
      "modules_avec_rubriques": 2,
      "total_rubriques": 8
    },
    "modifications_appliquees": {
      "modules_exclus": 1,
      "modules_ajoutes": 1
    },
    "created_at": "2025-01-15T15:30:00Z",
    "created_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Code unique** : V√©rification ou g√©n√©ration avec suffixe
- **Copie profonde** : Tous les modules et rubriques
- **Modifications optionnelles** : Appliqu√©es pendant duplication
- **Transaction compl√®te** : ROLLBACK si erreur
- **Audit trail** : Lien avec profil source

---

## üîß US-GG-010 : Export/Import de Profils

### **GET /api/v1/back-office/profils/export**

#### **R√®gles M√©tier**

1. **Export s√©lectif** : Choix des profils √† exporter
2. **Format JSON** : Structure r√©utilisable pour import
3. **Sans donn√©es sensibles** : Pas d'ID, pas d'utilisateurs
4. **M√©tadonn√©es incluses** : Version, date, √©tablissement source
5. **Validation structure** : Sch√©ma JSON valide

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre          | Type    | Description                                 |
| ------------------ | ------- | ------------------------------------------- |
| profils_ids[]      | array   | IDs des profils √† exporter (tous si absent) |
| include_predefinit | boolean | Inclure profils pr√©d√©finis                  |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "export": {
      "version": "1.0",
      "date_export": "2025-01-15T15:30:00Z",
      "etablissement_source": "CENTREA",
      "nombre_profils": 3,
      "profils": [
        {
          "code_profil": "MEDECIN",
          "nom_profil": "M√©decins",
          "description": "Profil pour les m√©decins",
          "modules": [
            {
              "code_module": "CONSULTATION",
              "acces_toutes_rubriques": true,
              "rubriques": []
            },
            {
              "code_module": "URGENCES",
              "acces_toutes_rubriques": false,
              "rubriques": ["TRIAGE", "ORIENTATION"]
            }
          ]
        }
      ]
    },
    "export_metadata": {
      "exported_by": {
        "id": "admin-uuid",
        "nom": "Admin",
        "prenoms": "System"
      },
      "format": "json",
      "taille_octets": 2048
    }
  }
}
```

### **POST /api/v1/back-office/profils/import**

#### **Request Body**

```json
{
  "import_data": {
    "version": "1.0",
    "profils": [
      {
        "code_profil": "MEDECIN_IMPORT",
        "nom_profil": "M√©decins Import√©s",
        "description": "Profil import√© depuis autre √©tablissement",
        "modules": [
          {
            "code_module": "CONSULTATION",
            "acces_toutes_rubriques": true
          }
        ]
      }
    ]
  },
  "options": {
    "prefixe_code": "IMP_", // OPTIONNEL - pr√©fixe pour √©viter conflits
    "ecrasement": false, // OPTIONNEL - √©craser si code existe
    "validation_seule": false // OPTIONNEL - dry run
  }
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "resultats": {
      "profils_importes": 1,
      "profils_ignores": 0,
      "profils_modifies": 0
    },
    "details": [
      {
        "code_profil_original": "MEDECIN_IMPORT",
        "code_profil_final": "IMP_MEDECIN_IMPORT",
        "statut": "import√©",
        "id": "new-profil-uuid",
        "modules_valides": 1,
        "modules_ignores": 0
      }
    ],
    "validation": {
      "modules_non_autorises": [],
      "rubriques_invalides": []
    },
    "imported_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "Import"
    },
    "imported_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Validation licence** : Modules doivent √™tre dans modules_autorises
- **Mapping codes** : Correspondance code_module pas ID
- **Gestion conflits** : Pr√©fixe ou √©crasement selon options
- **Transaction atomique** : Tout ou rien pour l'import
- **Rapport d√©taill√©** : Succ√®s et √©checs par profil

---

## üìä Requ√™tes SQL Optimis√©es

### GetProfilsWithStats

```sql
-- Requ√™te optimis√©e pour liste des profils avec statistiques
WITH profil_stats AS (
    SELECT
        pt.id,
        COUNT(DISTINCT pu.utilisateur_id) FILTER (WHERE pu.est_actif = TRUE) as nb_users_actifs,
        COUNT(DISTINCT pu.utilisateur_id) as nb_users_total
    FROM user_profil_template pt
    LEFT JOIN user_profil_utilisateurs pu ON pt.id = pu.profil_template_id
    WHERE pt.etablissement_id = $1
    GROUP BY pt.id
),
profil_permissions AS (
    SELECT
        pt.id,
        COUNT(DISTINCT pm.module_id) as nb_modules,
        COUNT(DISTINCT pm.module_id) FILTER (WHERE pm.acces_toutes_rubriques = TRUE) as nb_modules_complets,
        COUNT(DISTINCT pr.rubrique_id) as nb_rubriques
    FROM user_profil_template pt
    LEFT JOIN user_profil_modules pm ON pt.id = pm.profil_template_id AND pm.est_actif = TRUE
    LEFT JOIN user_profil_rubriques pr ON pt.id = pr.profil_template_id AND pr.est_actif = TRUE
    WHERE pt.etablissement_id = $1
    GROUP BY pt.id
)
SELECT
    pt.id,
    pt.code_profil,
    pt.nom_profil,
    pt.description,
    pt.est_predefinit,
    pt.est_actif,
    pt.created_at,
    pt.updated_at,
    jsonb_build_object(
        'id', u.id,
        'nom', u.nom,
        'prenoms', u.prenoms
    ) as created_by,
    jsonb_build_object(
        'nombre_utilisateurs', COALESCE(ps.nb_users_total, 0),
        'nombre_utilisateurs_actifs', COALESCE(ps.nb_users_actifs, 0),
        'nombre_modules', COALESCE(pp.nb_modules, 0),
        'nombre_modules_complets', COALESCE(pp.nb_modules_complets, 0),
        'nombre_rubriques_specifiques', COALESCE(pp.nb_rubriques, 0)
    ) as statistiques
FROM user_profil_template pt
LEFT JOIN profil_stats ps ON pt.id = ps.id
LEFT JOIN profil_permissions pp ON pt.id = pp.id
LEFT JOIN user_utilisateur u ON pt.created_by = u.id
WHERE pt.etablissement_id = $1
    AND ($2::boolean IS NULL OR pt.est_actif = $2)
    AND ($3::boolean IS NULL OR pt.est_predefinit = $3)
    AND ($4::text IS NULL OR pt.nom_profil ILIKE '%' || $4 || '%'
         OR pt.description ILIKE '%' || $4 || '%')
ORDER BY
    CASE WHEN $5 = 'nom_profil' THEN pt.nom_profil END ASC,
    CASE WHEN $5 = 'created_at' THEN pt.created_at END DESC,
    CASE WHEN $5 = 'nb_users' THEN ps.nb_users_total END DESC
LIMIT $6 OFFSET $7;
```

### DuplicateProfil

```sql
-- Transaction pour duplication compl√®te d'un profil
BEGIN;

-- 1. Cr√©er le nouveau profil
INSERT INTO user_profil_template (
    etablissement_id,
    code_profil,
    nom_profil,
    description,
    est_predefinit,
    est_actif,
    created_by
)
SELECT
    etablissement_id,
    $2, -- nouveau code_profil
    $3, -- nouveau nom_profil
    $4, -- nouvelle description
    FALSE, -- jamais pr√©d√©fini pour une copie
    $5, -- est_actif
    $6  -- created_by (utilisateur courant)
FROM user_profil_template
WHERE id = $1
RETURNING id INTO new_profil_id;

-- 2. Copier les modules
INSERT INTO user_profil_modules (
    etablissement_id,
    profil_template_id,
    module_id,
    acces_toutes_rubriques,
    est_actif,
    created_by
)
SELECT
    etablissement_id,
    new_profil_id,
    module_id,
    acces_toutes_rubriques,
    est_actif,
    $6 -- created_by
FROM user_profil_modules
WHERE profil_template_id = $1
    AND est_actif = TRUE
    AND module_id NOT IN (SELECT unnest($7::uuid[])); -- modules √† exclure

-- 3. Copier les rubriques
INSERT INTO user_profil_rubriques (
    etablissement_id,
    profil_template_id,
    module_id,
    rubrique_id,
    est_actif,
    created_by
)
SELECT
    etablissement_id,
    new_profil_id,
    module_id,
    rubrique_id,
    est_actif,
    $6 -- created_by
FROM user_profil_rubriques
WHERE profil_template_id = $1
    AND est_actif = TRUE
    AND module_id NOT IN (SELECT unnest($7::uuid[])); -- coh√©rence avec modules exclus

COMMIT;
```

---

## üõ°Ô∏è S√©curit√© et Audit

### √âv√©nements √† Logger

1. **Cr√©ation profil** : D√©tails complets du profil cr√©√©
2. **Modification profil** : Diff avant/apr√®s des permissions
3. **Suppression profil** : Archivage complet avant suppression
4. **Attribution utilisateurs** : Liste des utilisateurs et permissions accord√©es
5. **Retrait utilisateurs** : Liste et permissions perdues
6. **Import/Export** : Source, destination, r√©sultats

### Format Log Audit

```json
{
  "timestamp": "2025-01-15T15:30:00Z",
  "event_type": "PROFILE_USER_ATTRIBUTION",
  "actor": {
    "id": "admin-uuid",
    "identifiant": "admin.rh",
    "ip": "192.168.1.100"
  },
  "target": {
    "profile_id": "profil-uuid",
    "profile_name": "M√©decins",
    "users_count": 3
  },
  "changes": {
    "users_added": ["user-1", "user-2"],
    "permissions_granted": {
      "modules": 8,
      "rubriques": 15
    }
  },
  "metadata": {
    "establishment_code": "CENTREA",
    "request_id": "req-uuid"
  }
}
```

---

## ‚ö° Optimisations Performance

1. **Index composites** : (etablissement_id, est_actif, code_profil)
2. **Eager loading** : Jointures pour √©viter N+1 queries
3. **Batch operations** : INSERT/UPDATE en masse
4. **CTEs r√©cursifs** : Pour calculs statistiques complexes
5. **Pagination obligatoire** : Sur listes utilisateurs dans profils
6. **Connection pooling** : R√©utilisation connexions PostgreSQL

---

## ‚úÖ Checklist Impl√©mentation

### Endpoints Principaux

- [ ] GET /api/v1/back-office/profils - Liste avec statistiques
- [ ] GET /api/v1/back-office/profils/{id} - D√©tails complets
- [ ] POST /api/v1/back-office/profils - Cr√©ation profil
- [ ] PUT /api/v1/back-office/profils/{id} - Modification
- [ ] DELETE /api/v1/back-office/profils/{id} - Suppression

### Gestion Utilisateurs

- [ ] POST /api/v1/back-office/profils/{id}/users - Attribution masse
- [ ] DELETE /api/v1/back-office/profils/{id}/users/{user_id} - Retrait unitaire
- [ ] DELETE /api/v1/back-office/profils/{id}/users - Retrait masse
- [ ] GET /api/v1/back-office/profils/{id}/users - Liste pagin√©e

### Fonctionnalit√©s Avanc√©es

- [ ] POST /api/v1/back-office/profils/{id}/duplicate - Duplication
- [ ] GET /api/v1/back-office/profils/export - Export JSON
- [ ] POST /api/v1/back-office/profils/import - Import JSON
- [ ] GET /api/v1/back-office/profils/templates - Profils types

### Infrastructure

- [ ] Service Layer avec validation m√©tier
- [ ] Queries PostgreSQL optimis√©es
- [ ] Validation multi-tenant stricte
- [ ] Audit trail complet
- [ ] Tests unitaires et int√©gration

---

**Cette sp√©cification garantit un syst√®me de gestion des groupes/profils robuste, flexible et performant, permettant une administration efficace des permissions √† grande √©chelle tout en maintenant la tra√ßabilit√© compl√®te.**
