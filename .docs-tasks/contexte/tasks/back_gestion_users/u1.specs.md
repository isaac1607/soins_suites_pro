# SP√âCIFICATIONS TECHNIQUES - MODULE GESTION UTILISATEURS

## üìã Informations G√©n√©rales

- **Module :** Gestion des Utilisateurs (Back-Office)
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Services ‚Üí Queries ‚Üí DB (PostgreSQL + Redis)
- **Rubriques :** GESTION_COMPTES, GESTION_GROUPES

## üéØ Objectif

D√©velopper un syst√®me complet de gestion des utilisateurs et groupes/profils m√©tier permettant :

- CRUD complet des utilisateurs avec permissions granulaires
- Gestion de groupes m√©tier (profils) avec attribution en masse
- Attribution flexible : via profils (90%) ou individuelle (10%)
- Duplication de permissions entre utilisateurs
- Recherche et filtrage avanc√©s

## üèóÔ∏è Architecture Technique

```
internal/modules/back-office/users/
‚îú‚îÄ‚îÄ users.module.go                    # Module Fx
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ comptes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ comptes.controller.go      # CRUD utilisateurs
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.controller.go      # Gestion groupes/profils
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ comptes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ comptes.service.go         # Logique utilisateurs
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.service.go         # Logique groupes
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ comptes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ comptes.dto.go            # DTOs utilisateurs
‚îÇ   ‚îî‚îÄ‚îÄ groupes/
‚îÇ       ‚îî‚îÄ‚îÄ groupes.dto.go            # DTOs groupes
‚îî‚îÄ‚îÄ queries/
    ‚îú‚îÄ‚îÄ comptes/
    ‚îÇ   ‚îî‚îÄ‚îÄ comptes.postgres.go        # Requ√™tes utilisateurs
    ‚îî‚îÄ‚îÄ groupes/
        ‚îî‚îÄ‚îÄ groupes.postgres.go        # Requ√™tes groupes
```

---

## üîß RUBRIQUE 1 : GESTION_COMPTES

### **GET /api/v1/users**

#### Description

Liste pagin√©e des utilisateurs avec filtrage avanc√©

#### Headers Requis

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### Query Parameters

```
?page=1&limit=20&search=john&statut=actif&est_admin=false&profil_id=uuid
```

#### Response 200

```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "identifiant": "john.doe",
        "nom": "DOE",
        "prenoms": "John",
        "telephone": "0612345678",
        "est_admin": false,
        "est_medecin": true,
        "role_metier": "M√©decin g√©n√©raliste",
        "statut": "actif",
        "profils": [
          {
            "id": "profil-uuid",
            "nom_profil": "M√©decins",
            "code_profil": "MEDECIN"
          }
        ],
        "modules_count": 5,
        "last_login_at": "2025-01-15T10:00:00Z",
        "created_at": "2025-01-01T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 150,
      "total_pages": 8
    }
  }
}
```

---

### **GET /api/v1/users/{id}**

#### Description

D√©tails complets d'un utilisateur avec permissions

#### Response 200

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "identifiant": "john.doe",
      "nom": "DOE",
      "prenoms": "John",
      "telephone": "0612345678",
      "email": "john.doe@hospital.com",
      "est_admin": false,
      "type_admin": null,
      "est_medecin": true,
      "role_metier": "M√©decin g√©n√©raliste",
      "est_temporaire": false,
      "date_expiration": null,
      "statut": "actif",
      "must_change_password": false,
      "last_login_at": "2025-01-15T10:00:00Z",
      "created_at": "2025-01-01T10:00:00Z",
      "created_by": {
        "id": "admin-uuid",
        "nom": "Admin",
        "prenoms": "System"
      }
    },
    "profils": [
      {
        "id": "profil-uuid",
        "nom_profil": "M√©decins",
        "code_profil": "MEDECIN",
        "date_attribution": "2025-01-01T10:00:00Z",
        "attribue_par": "Admin System"
      }
    ],
    "permissions": [
        {
          "code_module": "CONSULTATION",
          "nom": "Consultation",
          "acces_complet": true,
          "rubriques": [],
          "source": "profil",
          "profil": "M√©decins",
          "date_attribution": "2025-01-10T10:00:00Z"
        },
        {
          "code_module": "URGENCES",
          "nom": "Urgences",
          "acces_complet": false,
          "rubriques": [
            {
              "code_rubrique": "TRIAGE",
              "nom": "Triage urgences"
            }
          ],
          "source": "individuelle",
          "profil": null,
          "date_attribution": "2025-01-10T10:00:00Z"
        }
      ]
    }
  }
}
```

---

### **POST /api/v1/users**

#### Description

Cr√©ation utilisateur avec attribution permissions optionnelle

#### Request Body

```json
{
  "identifiant": "marie.curie",
  "nom": "CURIE",
  "prenoms": "Marie",
  "telephone": "0612345678",
  "password": "TempPass123!",
  "est_admin": false,
  "est_medecin": true,
  "role_metier": "M√©decin sp√©cialiste",
  "est_temporaire": false,
  "profils_ids": ["profil-medecin-uuid"],
  "modules": [
    {
      "module_id": "module-urgences-uuid",
      "acces_complet": false,
      "rubriques_ids": ["rubrique-triage-uuid"]
    }
  ]
}
```

#### Response 201

```json
{
  "success": true,
  "data": {
    "id": "new-user-uuid",
    "identifiant": "marie.curie",
    "message": "Utilisateur cr√©√© avec succ√®s",
    "permissions_attribuees": {
      "profils": 1,
      "modules": 3,
      "rubriques": 2
    }
  }
}
```

---

### **PUT /api/v1/users/{id}**

#### Description

Modification informations utilisateur (sans permissions)

#### Request Body

```json
{
  "nom": "CURIE-SKLODOWSKA",
  "prenoms": "Marie",
  "telephone": "0698765432",
  "role_metier": "Chef de service",
  "statut": "actif"
}
```

---

### **DELETE /api/v1/users/{id}**

#### Description

D√©sactivation utilisateur (soft delete)

#### Response 200

```json
{
  "success": true,
  "message": "Utilisateur d√©sactiv√© avec succ√®s"
}
```

---

### **POST /api/v1/users/{id}/reset-password**

#### Description

R√©initialisation mot de passe

#### Request Body

```json
{
  "new_password": "NewSecurePass123!",
  "force_change": true
}
```

---

### **GET /api/v1/users/{id}/permissions**

#### Description

Permissions d√©taill√©es d'un utilisateur

#### Response 200

```json
{
  "success": true,
  "data": {
    "permissions_effectives": [
      {
        "code_module": "CONSULTATION",
        "nom": "Consultation",
        "source": "profil:MEDECIN",
        "acces_complet": true,
        "rubriques": []
      },
      {
        "code_module": "URGENCES",
        "nom": "Urgences",
        "source": "individuelle",
        "acces_complet": false,
        "rubriques": ["TRIAGE", "ORIENTATION"]
      }
    ],
    "resume": {
      "total_modules": 5,
      "modules_complets": 4,
      "modules_partiels": 1,
      "total_rubriques": 8
    }
  }
}
```

---

### **PUT /api/v1/users/{id}/permissions**

#### Description

Modification permissions individuelles utilisateur

#### Request Body

```json
{
  "modules_a_ajouter": [
    {
      "module_id": "module-laboratoire-uuid",
      "acces_complet": true
    }
  ],
  "modules_a_retirer": ["module-urgences-uuid"],
  "rubriques_a_ajouter": [
    {
      "module_id": "module-imagerie-uuid",
      "rubrique_id": "rubrique-irm-uuid"
    }
  ],
  "rubriques_a_retirer": []
}
```

---

### **POST /api/v1/users/{id}/duplicate-permissions**

#### Description

Duplication permissions d'un utilisateur vers un autre

#### Request Body

```json
{
  "utilisateur_cible_id": "target-user-uuid",
  "inclure_profils": true,
  "inclure_permissions_individuelles": true,
  "remplacer_existant": false
}
```

#### Response 200

```json
{
  "success": true,
  "data": {
    "permissions_copiees": {
      "profils": 2,
      "modules": 5,
      "rubriques": 12
    },
    "message": "Permissions dupliqu√©es avec succ√®s"
  }
}
```

---

## üîß RUBRIQUE 2 : GESTION_GROUPES

### **GET /api/v1/profils**

#### Description

Liste des profils/groupes m√©tier

#### Response 200

```json
{
  "success": true,
  "data": {
    "profils": [
      {
        "id": "profil-uuid",
        "code_profil": "MEDECIN",
        "nom_profil": "M√©decins",
        "description": "Profil pour les m√©decins de l'√©tablissement",
        "est_predefinit": false,
        "est_actif": true,
        "nombre_utilisateurs": 25,
        "nombre_modules": 8,
        "created_at": "2025-01-01T10:00:00Z"
      }
    ]
  }
}
```

---

### **GET /api/v1/profils/{id}**

#### Description

D√©tails complets d'un profil avec permissions

#### Response 200

```json
{
  "success": true,
  "data": {
    "profil": {
      "id": "profil-uuid",
      "code_profil": "MEDECIN",
      "nom_profil": "M√©decins",
      "description": "Profil pour les m√©decins de l'√©tablissement",
      "est_predefinit": false,
      "est_actif": true,
      "created_at": "2025-01-01T10:00:00Z"
    },
    "permissions": [
      {
        "code_module": "CONSULTATION",
        "nom": "Consultation",
        "acces_complet": true,
        "rubriques": []
      },
      {
        "code_module": "DOSSIER_PATIENT",
        "nom": "Dossier Patient",
        "acces_complet": false,
        "rubriques": [
          {
            "code_rubrique": "ANTECEDENTS",
            "nom": "Ant√©c√©dents m√©dicaux"
          },
          {
            "code_rubrique": "PRESCRIPTIONS",
            "nom": "Prescriptions"
          }
        ]
      }
    ],
    "utilisateurs": [
      {
        "id": "user-uuid",
        "identifiant": "john.doe",
        "nom": "DOE",
        "prenoms": "John",
        "date_attribution": "2025-01-05T10:00:00Z"
      }
    ],
    "statistiques": {
      "total_utilisateurs": 25,
      "utilisateurs_actifs": 23,
      "derniere_attribution": "2025-01-14T10:00:00Z"
    }
  }
}
```

---

### **POST /api/v1/profils**

#### Description

Cr√©ation nouveau profil m√©tier

#### Request Body

```json
{
  "code_profil": "INFIRMIER",
  "nom_profil": "Infirmiers",
  "description": "Profil pour le personnel infirmier",
  "modules": [
    {
      "module_id": "module-soins-uuid",
      "acces_complet": true
    },
    {
      "module_id": "module-dossier-patient-uuid",
      "acces_complet": false,
      "rubriques_ids": ["rubrique-signes-vitaux-uuid", "rubrique-soins-uuid"]
    }
  ]
}
```

---

### **PUT /api/v1/profils/{id}**

#### Description

Modification profil et permissions

#### Request Body

```json
{
  "nom_profil": "Infirmiers - Service Urgences",
  "description": "Profil sp√©cialis√© urgences",
  "modules_a_ajouter": [
    {
      "module_id": "module-urgences-uuid",
      "acces_complet": true
    }
  ],
  "modules_a_retirer": [],
  "rubriques_a_modifier": [
    {
      "module_id": "module-dossier-patient-uuid",
      "rubriques_ids": ["rubrique-triage-uuid"]
    }
  ]
}
```

---

### **DELETE /api/v1/profils/{id}**

#### Description

Suppression profil (si aucun utilisateur associ√©)

#### Response 200/400

```json
{
  "success": false,
  "error": "Impossible de supprimer ce profil",
  "details": {
    "reason": "25 utilisateurs sont encore associ√©s √† ce profil"
  }
}
```

---

### **POST /api/v1/profils/{id}/users**

#### Description

Ajout utilisateurs √† un profil

#### Request Body

```json
{
  "utilisateurs_ids": ["user-uuid-1", "user-uuid-2", "user-uuid-3"]
}
```

#### Response 200

```json
{
  "success": true,
  "data": {
    "utilisateurs_ajoutes": 3,
    "utilisateurs_deja_presents": 0,
    "message": "3 utilisateurs ajout√©s au profil avec succ√®s"
  }
}
```

---

### **DELETE /api/v1/profils/{id}/users/{user_id}**

#### Description

Retrait utilisateur d'un profil

#### Response 200

```json
{
  "success": true,
  "message": "Utilisateur retir√© du profil avec succ√®s"
}
```

---

### **GET /api/v1/profils/{id}/users**

#### Description

Liste des utilisateurs d'un profil

#### Response 200

```json
{
  "success": true,
  "data": {
    "profil": "M√©decins",
    "utilisateurs": [
      {
        "id": "user-uuid",
        "identifiant": "john.doe",
        "nom": "DOE",
        "prenoms": "John",
        "date_attribution": "2025-01-05T10:00:00Z",
        "attribue_par": "Admin System"
      }
    ],
    "total": 25
  }
}
```

---

## üîß ENDPOINTS ADDITIONNELS MVP

### **GET /api/v1/users/search**

#### Description

Recherche avanc√©e multi-crit√®res

#### Query Parameters

```
?q=john&modules[]=CONSULTATION&profils[]=MEDECIN&has_admin=false
```

---

### **GET /api/v1/users/export**

#### Description

Export CSV/Excel liste utilisateurs

#### Query Parameters

```
?format=csv&include_permissions=true
```

---

### **POST /api/v1/users/bulk-create**

#### Description

Cr√©ation en masse d'utilisateurs (import)

#### Request Body

```json
{
  "utilisateurs": [
    {
      "identifiant": "user1",
      "nom": "NOM1",
      "prenoms": "Prenom1",
      "telephone": "0612345678",
      "profil_id": "profil-uuid"
    }
  ],
  "mot_de_passe_par_defaut": "TempPass123!",
  "forcer_changement": true
}
```

---

### **GET /api/v1/modules-disponibles**

#### Description

Liste modules disponibles pour attribution (filtr√©s par licence)

#### Response 200

```json
{
  "success": true,
  "data": {
    "modules": [
      {
        "id": "module-uuid",
        "code_module": "CONSULTATION",
        "nom_standard": "Consultation",
        "est_medical": true,
        "est_autorise": true, // V√©rifi√© via base_licence.modules_autorises
        "rubriques": [
          {
            "id": "rubrique-uuid",
            "code_rubrique": "ANAMNESE",
            "nom": "Anamn√®se"
          }
        ]
      },
      {
        "id": "module-uuid-2",
        "code_module": "LABORATOIRE",
        "nom_standard": "Laboratoire",
        "est_medical": true,
        "est_autorise": false, // Non pr√©sent dans modules_autorises
        "rubriques": []
      }
    ],
    "modules_autorises_count": 8,
    "modules_total_count": 15
  }
}
```

---

## üìä Requ√™tes SQL Principales

### GetUserWithAllPermissions

```sql
-- CTE pour aggreger toutes les permissions effectives
WITH permissions_profils AS (
    -- Permissions via profils
    SELECT DISTINCT
        u.id as user_id,
        m.code_module,
        m.nom_standard,
        pm.acces_toutes_rubriques,
        pt.nom_profil as source,
        CASE
            WHEN pm.acces_toutes_rubriques THEN '[]'::jsonb
            ELSE jsonb_agg(DISTINCT r.code_rubrique)
        END as rubriques
    FROM user_profil_utilisateurs pu
    JOIN user_profil_template pt ON pu.profil_template_id = pt.id
    JOIN user_profil_modules pm ON pm.profil_template_id = pt.id
    JOIN base_module m ON pm.module_id = m.id
    LEFT JOIN user_profil_rubriques pr ON pr.profil_template_id = pt.id
    LEFT JOIN base_rubrique r ON pr.rubrique_id = r.id
    WHERE pu.utilisateur_id = $1 AND pu.est_actif = TRUE
    GROUP BY u.id, m.code_module, m.nom_standard, pm.acces_toutes_rubriques, pt.nom_profil
),
permissions_individuelles AS (
    -- Permissions individuelles
    SELECT DISTINCT
        u.id as user_id,
        m.code_module,
        m.nom_standard,
        um.acces_toutes_rubriques,
        'individuelle' as source,
        CASE
            WHEN um.acces_toutes_rubriques THEN '[]'::jsonb
            ELSE jsonb_agg(DISTINCT r.code_rubrique)
        END as rubriques
    FROM user_modules um
    JOIN base_module m ON um.module_id = m.id
    LEFT JOIN user_modules_rubriques umr ON umr.utilisateur_id = um.utilisateur_id
    LEFT JOIN base_rubrique r ON umr.rubrique_id = r.id
    WHERE um.utilisateur_id = $1 AND um.est_actif = TRUE
    GROUP BY u.id, m.code_module, m.nom_standard, um.acces_toutes_rubriques
)
-- Union et d√©duplication
SELECT * FROM permissions_profils
UNION
SELECT * FROM permissions_individuelles
ORDER BY code_module;
```

---

## üîÑ R√®gles M√©tier

### Attribution Permissions

1. **Profils prioritaires** : 90% des attributions via profils
2. **Cumul permissions** : Profils + individuelles = union
3. **Pas de soustraction** : On ne peut que ajouter des droits
4. **Cascade profil** : Suppression profil = perte permissions associ√©es
5. **Audit complet** : Tra√ßabilit√© qui/quand pour chaque attribution

### Gestion Utilisateurs

1. **Identifiant unique** : Par √©tablissement
2. **Soft delete** : D√©sactivation, pas suppression
3. **Mot de passe** : Hashage Sha512 + salt (voir `internal/shared/utils/crypt.go`)
4. **Sessions multiples** : Support multi-device
5. **Expiration compte** : Pour utilisateurs temporaires

### Gestion Profils

1. **Code unique** : Par √©tablissement
2. **Profils pr√©d√©finis** : Non modifiables (syst√®me)
3. **Suppression** : Impossible si utilisateurs associ√©s
4. **Modification** : Impact imm√©diat sur tous les utilisateurs

---

## ‚ö° Optimisations Cache

### Redis Cache Strategy

```
# Cache utilisateur complet
soins_suite_{etablissement}_cache_user:{user_id}
TTL: 900s (15 min)

# Cache permissions utilisateur
soins_suite_{etablissement}_cache_user_permissions:{user_id}
TTL: 3600s (1h)

# Cache profil
soins_suite_{etablissement}_cache_profil:{profil_id}
TTL: 3600s (1h)

# Invalidation sur modification
- User update ‚Üí Del cache_user
- Permission change ‚Üí Del cache_user_permissions
- Profil update ‚Üí Del cache_profil + tous cache_user_permissions associ√©s
```

---

## üõ°Ô∏è S√©curit√©

1. **Validation √©tablissement** : Via EstablishmentMiddleware
2. **Permissions requises** :
   - GESTION_COMPTES : CRUD utilisateurs
   - GESTION_GROUPES : CRUD profils
3. **Audit trail** : Qui fait quoi et quand
4. **Rate limiting** : Sur cr√©ation/modification masse
5. **Validation donn√©es** : DTOs avec validation stricte

---

## ‚úÖ Checklist Impl√©mentation

### Gestion Comptes

- [ ] GET /api/v1/users - Liste pagin√©e
- [ ] GET /api/v1/users/{id} - D√©tails utilisateur
- [ ] POST /api/v1/users - Cr√©ation
- [ ] PUT /api/v1/users/{id} - Modification
- [ ] DELETE /api/v1/users/{id} - D√©sactivation
- [ ] POST /api/v1/users/{id}/reset-password
- [ ] GET /api/v1/users/{id}/permissions
- [ ] PUT /api/v1/users/{id}/permissions
- [ ] POST /api/v1/users/{id}/duplicate-permissions

### Gestion Groupes

- [ ] GET /api/v1/profils - Liste profils
- [ ] GET /api/v1/profils/{id} - D√©tails profil avec est_actif
- [ ] POST /api/v1/profils - Cr√©ation profil
- [ ] PUT /api/v1/profils/{id} - Modification avec gestion est_actif
- [ ] DELETE /api/v1/profils/{id} - Suppression
- [ ] POST /api/v1/profils/{id}/users - Ajout utilisateurs
- [ ] DELETE /api/v1/profils/{id}/users/{user_id} - Retrait
- [ ] GET /api/v1/profils/{id}/users - Liste utilisateurs
- [ ] POST /api/v1/profils/{id}/modules/{module_id}/toggle - Activer/D√©sactiver module
- [ ] GET /api/v1/profils/{id}/historique - Audit trail

### Endpoints Additionnels

- [ ] GET /api/v1/users/search - Recherche avanc√©e
- [ ] GET /api/v1/users/export - Export donn√©es
- [ ] POST /api/v1/users/bulk-create - Cr√©ation masse
- [ ] GET /api/v1/modules-disponibles - Modules pour attribution

---

## üìù Notes d'Impl√©mentation

### Structure Permissions dans Response

```go
type PermissionResponse struct {
    CodeModule    string   `json:"code_module"`
    Nom          string   `json:"nom"`
    Source       string   `json:"source"` // "profil:MEDECIN" ou "individuelle"
    AccesComplet bool     `json:"acces_complet"`
    Rubriques    []string `json:"rubriques"` // Vide si acc√®s complet
}
```

### Validation Coh√©rence

```go
// Si acces_complet = true, rubriques doit √™tre vide
// Si acces_complet = false, au moins une rubrique requise
```

### Pattern Duplication

```go
// Transaction PostgreSQL pour atomicit√©
// 1. R√©cup√©rer permissions source
// 2. Filtrer selon options
// 3. Ins√©rer en masse
// 4. Invalider cache cible
```

---

**Ces sp√©cifications garantissent un syst√®me de gestion utilisateurs complet, flexible et performant, adapt√© aux besoins d'un √©tablissement m√©dical multi-tenant.**
