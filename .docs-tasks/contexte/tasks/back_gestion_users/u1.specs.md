# SP√âCIFICATIONS TECHNIQUES - MODULE GESTION UTILISATEURS - RUBRIQUE GESTION_COMPTES

## üìã Informations G√©n√©rales

- **Module :** Gestion des Utilisateurs (Back-Office)
- **Rubrique :** GESTION_COMPTES
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Services ‚Üí Queries ‚Üí DB (PostgreSQL)

## üéØ Objectif

D√©velopper un syst√®me complet de gestion des comptes utilisateurs permettant :

- CRUD complet des utilisateurs avec gestion flexible des permissions
- Attribution de permissions via profils m√©tier (60% des cas) ou individuelle (40% des cas)
- Duplication de permissions entre utilisateurs pour faciliter l'administration
- Recherche et filtrage avanc√©s multi-crit√®res
- Import/Export en masse des utilisateurs

## üèóÔ∏è Architecture Technique

```
internal/modules/back-office/users/
‚îú‚îÄ‚îÄ users.module.go                    # Module Fx
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ comptes/
‚îÇ       ‚îî‚îÄ‚îÄ comptes.controller.go      # CRUD utilisateurs
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ comptes/
‚îÇ       ‚îî‚îÄ‚îÄ comptes.service.go         # Logique utilisateurs
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ comptes/
‚îÇ       ‚îî‚îÄ‚îÄ comptes.dto.go            # DTOs utilisateurs
‚îî‚îÄ‚îÄ queries/
    ‚îî‚îÄ‚îÄ comptes/
        ‚îî‚îÄ‚îÄ comptes.postgres.go        # Requ√™tes SQL natives
```

---

## üîß US-GU-001 : Liste des Utilisateurs

### **GET /api/v1/back-office/users**

#### **R√®gles M√©tier**

1. **Filtrage multi-crit√®res** : Combinaison de tous les filtres avec op√©rateur AND
2. **Pagination obligatoire** : Limite max 100 enregistrements par page
3. **Tri par d√©faut** : Par date de cr√©ation d√©croissante
4. **Exclusion automatique** : Les utilisateurs archiv√©s sont exclus sauf si `include_archived=true`
5. **Permissions agr√©g√©es** : Comptage modules/rubriques sans d√©tails (performance)

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre        | Type    | D√©faut     | Description                              |
| ---------------- | ------- | ---------- | ---------------------------------------- |
| page             | integer | 1          | Num√©ro de page                           |
| limit            | integer | 20         | Nombre d'√©l√©ments (max: 100)             |
| search           | string  | -          | Recherche dans nom, pr√©noms, identifiant |
| statut           | string  | actif      | actif, suspendu, expire, tous            |
| est_admin        | boolean | -          | Filtrer administrateurs                  |
| est_medecin      | boolean | -          | Filtrer m√©decins                         |
| profil_id        | uuid    | -          | Filtrer par profil                       |
| module_code      | string  | -          | Utilisateurs ayant acc√®s au module       |
| sort_by          | string  | created_at | nom, identifiant, last_login_at          |
| sort_order       | string  | desc       | asc ou desc                              |
| include_archived | boolean | false      | Inclure utilisateurs archiv√©s            |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "identifiant": "john.doe",
        "nom": "DOE",
        "prenoms": "John",
        "telephone": "0612345678",
        "est_admin": false,
        "type_admin": null,
        "est_medecin": true,
        "role_metier": "M√©decin g√©n√©raliste",
        "est_temporaire": false,
        "date_expiration": null,
        "statut": "actif",
        "profils": [
          {
            "id": "profil-uuid",
            "nom_profil": "M√©decins",
            "code_profil": "MEDECIN"
          }
        ],
        "permissions_resume": {
          "total_modules": 5,
          "modules_complets": 4,
          "modules_partiels": 1,
          "total_rubriques": 12
        },
        "last_login_at": "2025-01-15T10:00:00Z",
        "created_at": "2025-01-01T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 150,
      "total_pages": 8,
      "has_next": true,
      "has_prev": false
    },
    "filtres_appliques": {
      "statut": "actif",
      "est_medecin": true,
      "sort_by": "created_at",
      "sort_order": "desc"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Performance** : Utilisation d'index composites sur (etablissement_id, statut, created_at)
- **Permissions r√©sum√©es** : Pas de d√©tails des permissions pour optimiser la performance
- **Profils multiples** : Un utilisateur peut appartenir √† plusieurs profils
- **Filtrage cumulatif** : Tous les filtres s'appliquent en AND

---

## üîß US-GU-002 : D√©tails d'un Utilisateur

### **GET /api/v1/back-office/users/{id}**

#### **R√®gles M√©tier**

1. **Donn√©es compl√®tes** : Retour de toutes les informations utilisateur
2. **Permissions d√©taill√©es** : Liste exhaustive avec source (profil ou individuelle)
3. **Historique inclus** : Derni√®res modifications et connexions
4. **Validation existence** : Erreur 404 si utilisateur inexistant ou archiv√©
5. **Audit trail** : Inclusion des m√©tadonn√©es de cr√©ation/modification

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "identifiant": "john.doe",
      "nom": "DOE",
      "prenoms": "John",
      "telephone": "0612345678",
      "email": "john.doe@hospital.com",
      "est_admin": false,
      "type_admin": null,
      "est_admin_tir": false,
      "est_medecin": true,
      "role_metier": "M√©decin g√©n√©raliste",
      "photo_url": "https://storage.example.com/photos/john-doe.jpg",
      "est_temporaire": false,
      "date_expiration": null,
      "statut": "actif",
      "motif_desactivation": null,
      "must_change_password": false,
      "password_changed_at": "2025-01-10T10:00:00Z",
      "last_login_at": "2025-01-15T10:00:00Z",
      "created_at": "2025-01-01T10:00:00Z",
      "updated_at": "2025-01-10T10:00:00Z",
      "created_by": {
        "id": "admin-uuid",
        "nom": "Admin",
        "prenoms": "System"
      },
      "updated_by": {
        "id": "admin-uuid",
        "nom": "Admin",
        "prenoms": "System"
      }
    },
    "profils": [
      {
        "id": "profil-uuid",
        "nom_profil": "M√©decins",
        "code_profil": "MEDECIN",
        "description": "Profil pour les m√©decins",
        "date_attribution": "2025-01-01T10:00:00Z",
        "attribue_par": {
          "id": "admin-uuid",
          "nom": "Admin",
          "prenoms": "System"
        },
        "est_actif": true
      }
    ],
    "permissions": {
      "modules_complets": [
        {
          "code_module": "CONSULTATION",
          "nom_standard": "Consultation",
          "nom_personnalise": null,
          "description": "Module de consultation m√©dicale",
          "source": "profil",
          "profil_source": "M√©decins",
          "date_attribution": "2025-01-01T10:00:00Z",
          "attribue_par": "Admin System"
        },
        {
          "code_module": "CAISSE",
          "nom_standard": "Caisse",
          "nom_personnalise": "Gestion Caisse",
          "description": "Module de gestion de caisse",
          "source": "individuelle",
          "profil_source": null,
          "date_attribution": "2025-01-05T10:00:00Z",
          "attribue_par": "Admin Finance"
        }
      ],
      "modules_partiels": [
        {
          "code_module": "URGENCES",
          "nom_standard": "Urgences",
          "nom_personnalise": null,
          "description": "Module des urgences",
          "source": "individuelle",
          "rubriques": [
            {
              "code_rubrique": "TRIAGE",
              "nom": "Triage urgences",
              "description": "Gestion du triage aux urgences"
            },
            {
              "code_rubrique": "ORIENTATION",
              "nom": "Orientation patients",
              "description": "Orientation des patients urgents"
            }
          ],
          "date_attribution": "2025-01-08T10:00:00Z",
          "attribue_par": "Chef Urgences"
        }
      ]
    },
    "statistiques": {
      "nombre_connexions_30j": 45,
      "derniere_activite": "2025-01-15T14:30:00Z",
      "nombre_sessions_actives": 2,
      "permissions_via_profils": 4,
      "permissions_individuelles": 2
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **S√©paration permissions** : Distinction claire entre modules complets et partiels
- **Tra√ßabilit√© compl√®te** : Qui a attribu√© quoi et quand
- **Source identifi√©e** : Chaque permission indique sa source (profil ou individuelle)
- **Statistiques temps r√©el** : Donn√©es calcul√©es √† la vol√©e depuis PostgreSQL
- **Photo optionnelle** : URL s√©curis√©e avec token si pr√©sente

---

## üîß US-GU-003 : Cr√©ation d'un Utilisateur

### **POST /api/v1/back-office/users**

#### **R√®gles M√©tier**

1. **Identifiant unique** : Validation unicit√© par √©tablissement
2. **Mot de passe temporaire** : G√©n√©ration automatique si non fourni
3. **Attribution permissions** : Profils ET/OU permissions individuelles en une transaction
4. **Validation coh√©rence** : est_admin n√©cessite type_admin
5. **Transaction atomique** : Tout ou rien (utilisateur + profils + permissions)

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Format des Champs pour le Front-End**

> **üìã Convention de Documentation :**
>
> - **Champs sans commentaire** = **OBLIGATOIRES**
> - **Champs avec `// OPTIONNEL`** = **FACULTATIFS**
> - **Champs conditionnels** = **OBLIGATOIRES sous certaines conditions** (pr√©cis√©es dans le commentaire)

#### **Request Body**

```json
{
  "identifiant": "marie.curie",
  "nom": "CURIE",
  "prenoms": "Marie",
  "telephone": "0612345678",
  "email": "marie.curie@hospital.com", // OPTIONNEL
  "password": "TempPass123!", // OPTIONNEL - g√©n√©r√© automatiquement si absent
  "must_change_password": true,
  "est_admin": false,
  "type_admin": null, // OPTIONNEL - requis seulement si est_admin = true
  "est_medecin": true,
  "role_metier": "M√©decin sp√©cialiste", // OPTIONNEL
  "est_temporaire": false,
  "date_expiration": null, // OPTIONNEL - requis seulement si est_temporaire = true
  "profils_ids": ["profil-medecin-uuid", "profil-urgences-uuid"], // OPTIONNEL
  "modules_attribues": [
    // OPTIONNEL
    {
      "module_id": "module-laboratoire-uuid",
      "acces_toutes_rubriques": true,
      "rubriques_specifiques": []
    },
    {
      "module_id": "module-imagerie-uuid",
      "acces_toutes_rubriques": false,
      "rubriques_specifiques": ["rubrique-irm-uuid", "rubrique-scanner-uuid"]
    }
  ]
}
```

#### **R√®gles de Validation**

| Champ                                        | Type     | Obligatoire | Validation                      | Description                              |
| -------------------------------------------- | -------- | ----------- | ------------------------------- | ---------------------------------------- |
| `identifiant`                                | string   | ‚úÖ          | 3-50 caract√®res                 | Identifiant unique par √©tablissement     |
| `nom`                                        | string   | ‚úÖ          | 2-100 caract√®res                | Nom de famille                           |
| `prenoms`                                    | string   | ‚úÖ          | 2-100 caract√®res                | Pr√©nom(s)                                |
| `telephone`                                  | string   | ‚úÖ          | 10-20 caract√®res                | Num√©ro de t√©l√©phone                      |
| `email`                                      | string   | ‚ùå          | Format email valide             | Email optionnel                          |
| `password`                                   | string   | ‚ùå          | Min 12 caract√®res               | G√©n√©r√© si absent                         |
| `must_change_password`                       | boolean  | ‚úÖ          | -                               | Force changement √† la connexion          |
| `est_admin`                                  | boolean  | ‚úÖ          | -                               | Statut administrateur                    |
| `type_admin`                                 | string   | üîÄ          | "super_admin" ou "admin_simple" | Requis si `est_admin = true`             |
| `est_medecin`                                | boolean  | ‚úÖ          | -                               | Statut m√©decin                           |
| `role_metier`                                | string   | ‚ùå          | Max 100 caract√®res              | Fonction/sp√©cialit√©                      |
| `est_temporaire`                             | boolean  | ‚úÖ          | -                               | Account temporaire                       |
| `date_expiration`                            | datetime | üîÄ          | Format ISO 8601                 | Requis si `est_temporaire = true`        |
| `profils_ids`                                | array    | ‚ùå          | UUIDs valides                   | Liste des profils √† attribuer            |
| `modules_attribues`                          | array    | ‚ùå          | -                               | Modules avec permissions individuelles   |
| `modules_attribues[].module_id`              | string   | ‚úÖ          | UUID valide                     | Identifiant du module                    |
| `modules_attribues[].acces_toutes_rubriques` | boolean  | ‚úÖ          | -                               | Acc√®s complet (true) ou partiel (false)  |
| `modules_attribues[].rubriques_specifiques`  | array    | üîÄ          | UUIDs valides                   | Requis si acces_toutes_rubriques = false |

**L√©gende :**

- ‚úÖ **Obligatoire** : Champ requis dans tous les cas
- ‚ùå **Optionnel** : Champ facultatif
- üîÄ **Conditionnel** : Obligatoire selon le contexte

#### **Response 201**

```json
{
  "success": true,
  "data": {
    "id": "new-user-uuid",
    "identifiant": "marie.curie",
    "password_temporaire": "TempPass123!", // OPTIONNEL - retourn√© seulement si g√©n√©r√© automatiquement
    "message": "Utilisateur cr√©√© avec succ√®s",
    "permissions_attribuees": {
      "profils": 2,
      "modules_complets": 5,
      "modules_partiels": 1,
      "total_rubriques": 18
    }
  }
}
```

#### **Response 400 - Validation Error**

```json
{
  "error": "Erreur de validation",
  "details": {
    "code": "VALIDATION_ERROR",
    "champs": {
      "identifiant": "Cet identifiant existe d√©j√†",
      "telephone": "Format de t√©l√©phone invalide",
      "permissions_individuelles.modules_partiels[0].module_id": "Module non autoris√© par la licence"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **G√©n√©ration mot de passe** : 12 caract√®res min, incluant maj/min/chiffres/sp√©ciaux
- **Validation modules** : V√©rification contre `base_licence.modules_autorises`
- **Coh√©rence rubriques** : Une rubrique n√©cessite son module parent
- **Audit complet** : Enregistrement created_by avec l'utilisateur courant

---

## üîß US-GU-004 : Modification d'un Utilisateur

### **PUT /api/v1/back-office/users/{id}**

#### **R√®gles M√©tier**

1. **Modification partielle** : Seuls les champs fournis sont modifi√©s
2. **Permissions s√©par√©es** : Modification permissions via endpoint d√©di√©
3. **Validation coh√©rence** : M√™mes r√®gles que cr√©ation
4. **Historique pr√©serv√©** : Enregistrement updated_by et updated_at

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "nom": "CURIE-SKLODOWSKA",
  "prenoms": "Marie",
  "telephone": "0698765432",
  "email": "marie.sklodowska@hospital.com",
  "role_metier": "Chef de service radiologie",
  "est_temporaire": true,
  "date_expiration": "2025-12-31T23:59:59Z",
  "statut": "actif"
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "id": "user-uuid",
    "message": "Utilisateur modifi√© avec succ√®s",
    "champs_modifies": [
      "nom",
      "telephone",
      "email",
      "role_metier",
      "est_temporaire",
      "date_expiration"
    ],
    "updated_at": "2025-01-15T15:30:00Z",
    "updated_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Identifiant immutable** : Ne peut pas √™tre modifi√© apr√®s cr√©ation
- **Mot de passe exclu** : Modification via endpoint d√©di√© reset-password
- **Statut transition** : actif ‚Üí suspendu n√©cessite motif_desactivation
- **Date expiration** : Obligatoire si est_temporaire = true

---

## üîß US-GU-005 : D√©sactivation/Archivage d'un Utilisateur

### **DELETE /api/v1/back-office/users/{id}**

#### **R√®gles M√©tier**

1. **Soft delete** : Changement statut vers "archive", pas de suppression physique
2. **Motif obligatoire** : Fourni via query parameter ou body
3. **Sessions r√©voqu√©es** : Toutes les sessions actives sont termin√©es
4. **Permissions pr√©serv√©es** : Historique conserv√© pour audit
5. **R√©activation possible** : Via PUT avec statut = "actif"

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre | Type   | Requis | Description                |
| --------- | ------ | ------ | -------------------------- |
| motif     | string | Oui    | Raison de la d√©sactivation |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "id": "user-uuid",
    "message": "Utilisateur archiv√© avec succ√®s",
    "statut": "archive",
    "motif_desactivation": "D√©part de l'√©tablissement",
    "sessions_revoquees": 2,
    "archived_at": "2025-01-15T15:30:00Z",
    "archived_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    }
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Cascade sessions** : Suppression PostgreSQL user_session
- **Audit trail** : Enregistrement dans table d'audit
- **Notification optionnelle** : Email √† l'utilisateur si configur√©
- **Blocage connexion** : Identifiant bloqu√© imm√©diatement
- **Export donn√©es** : Possibilit√© d'exporter avant archivage

---

## üîß US-GU-006 : R√©initialisation du Mot de Passe

### **POST /api/v1/back-office/users/{id}/reset-password**

#### **R√®gles M√©tier**

1. **G√©n√©ration s√©curis√©e** : Mot de passe fort g√©n√©r√© ou fourni
2. **Force changement** : Option pour forcer changement √† la prochaine connexion
3. **Notification** : Envoi automatique si email/SMS disponible
4. **Historique** : Enregistrement date et auteur de la r√©initialisation
5. **Sessions invalides** : R√©vocation optionnelle des sessions actives

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "new_password": "NewSecurePass123!", // Optionnel - g√©n√©r√© si absent
  "force_change": true,
  "revoke_sessions": true,
  "envoyer_notification": true,
  "methode_envoi": "email"
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "message": "Mot de passe r√©initialis√© avec succ√®s",
    "password_temporaire": "TempPass789!", // Seulement si g√©n√©r√©
    "must_change_password": true,
    "sessions_revoquees": 3,
    "notification": {
      "envoyee": true,
      "methode": "email",
      "destinataire": "john.doe@hospital.com"
    },
    "reset_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "Support"
    },
    "reset_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Complexit√© minimale** : 12 caract√®res, maj+min+chiffres+sp√©ciaux
- **Hash s√©curis√©** : SHA512 + salt unique (voir utils/crypto.go)
- **Limite tentatives** : Max 3 r√©initialisations par jour
- **Audit s√©curit√©** : Log √©v√©nement s√©curit√© critique
- **Token unique** : Si envoi par email, token valide 24h

---

## üîß US-GU-007 : Gestion des Permissions Utilisateur

### **GET /api/v1/back-office/users/{id}/permissions**

#### **R√®gles M√©tier**

1. **Vue consolid√©e** : Fusion permissions profils + individuelles
2. **Identification source** : Chaque permission indique son origine
3. **Calcul effectif** : Union de toutes les permissions
4. **Format structur√©** : S√©paration modules complets/partiels

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "user_id": "user-uuid",
    "permissions_effectives": {
      "modules_complets": [
        {
          "code_module": "CONSULTATION",
          "nom": "Consultation",
          "sources": [
            {
              "type": "profil",
              "nom": "M√©decins",
              "id": "profil-medecin-uuid"
            }
          ]
        },
        {
          "code_module": "CAISSE",
          "nom": "Caisse",
          "sources": [
            {
              "type": "individuelle",
              "date_attribution": "2025-01-05T10:00:00Z",
              "attribue_par": "Admin Finance"
            }
          ]
        }
      ],
      "modules_partiels": [
        {
          "code_module": "URGENCES",
          "nom": "Urgences",
          "rubriques": [
            {
              "code_rubrique": "TRIAGE",
              "nom": "Triage urgences"
            },
            {
              "code_rubrique": "ORIENTATION",
              "nom": "Orientation patients"
            }
          ],
          "sources": [
            {
              "type": "individuelle",
              "date_attribution": "2025-01-08T10:00:00Z",
              "attribue_par": "Chef Urgences"
            }
          ]
        }
      ]
    },
    "resume": {
      "total_modules": 8,
      "modules_complets": 6,
      "modules_partiels": 2,
      "total_rubriques_specifiques": 5,
      "permissions_via_profils": 5,
      "permissions_individuelles": 3
    },
    "profils_actifs": [
      {
        "id": "profil-medecin-uuid",
        "nom": "M√©decins",
        "modules_apportes": 5
      }
    ]
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **D√©duplication** : Si module via profil ET individuel, une seule entr√©e avec sources multiples
- **Priorit√© acc√®s complet** : Si acc√®s complet via une source, ignore les acc√®s partiels
- **Format optimis√©** : Structure plate pour faciliter l'utilisation frontend

---

## üîß US-GU-008 : Modification des Permissions

### **PUT /api/v1/back-office/users/{id}/permissions**

#### **R√®gles M√©tier**

1. **Modification delta** : Ajout/suppression, pas remplacement total
2. **Validation licence** : V√©rification modules autoris√©s
3. **Coh√©rence rubriques** : Rubrique n√©cessite module parent
4. **Transaction atomique** : Tout ou rien
5. **Notification optionnelle** : Information utilisateur des changements

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "profils": {
    "ajouter": ["profil-urgences-uuid"],
    "retirer": ["profil-consultation-uuid"]
  },
  "modules_complets": {
    "ajouter": [
      {
        "module_id": "module-laboratoire-uuid"
      }
    ],
    "retirer": ["module-radiologie-uuid"]
  },
  "modules_partiels": {
    "ajouter": [
      {
        "module_id": "module-pharmacie-uuid",
        "rubriques_ids": ["rubrique-dispensation-uuid", "rubrique-stock-uuid"]
      }
    ],
    "modifier": [
      {
        "module_id": "module-urgences-uuid",
        "rubriques_ids": ["rubrique-triage-uuid"] // Remplace les rubriques existantes
      }
    ],
    "retirer": ["module-imagerie-uuid"]
  },
  "notifier_utilisateur": true
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "message": "Permissions modifi√©es avec succ√®s",
    "changements": {
      "profils": {
        "ajoutes": 1,
        "retires": 1
      },
      "modules_complets": {
        "ajoutes": 1,
        "retires": 1
      },
      "modules_partiels": {
        "ajoutes": 1,
        "modifies": 1,
        "retires": 1
      },
      "total_rubriques_affectees": 8
    },
    "notification": {
      "envoyee": true,
      "methode": "email"
    },
    "modified_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "Permissions"
    },
    "modified_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Validation pr√©alable** : V√©rification tous les IDs existent
- **Gestion conflits** : Si module en acc√®s complet, ignore acc√®s partiel
- **Historique d√©taill√©** : Enregistrement chaque changement
- **Rollback si erreur** : Transaction PostgreSQL avec ROLLBACK

---

## üîß US-GU-009 : Duplication de Permissions

### **POST /api/v1/back-office/users/{id}/duplicate-permissions**

#### **R√®gles M√©tier**

1. **Copie s√©lective** : Choix profils et/ou permissions individuelles
2. **Mode fusion ou remplacement** : Ajout ou remplacement total
3. **Validation cible** : Utilisateur cible doit exister et √™tre actif
4. **Transaction unique** : Atomicit√© garantie
5. **Audit trail** : Tra√ßabilit√© source et destination

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: application/json
```

#### **Request Body**

```json
{
  "utilisateur_cible_id": "target-user-uuid",
  "options": {
    "inclure_profils": true,
    "inclure_modules_complets": true,
    "inclure_modules_partiels": true,
    "mode": "fusion" // "fusion" ou "remplacement"
  },
  "filtres": {
    "modules_only": ["CONSULTATION", "URGENCES"], // Optionnel - copier seulement certains modules
    "exclure_modules": ["ADMINISTRATION"] // Optionnel - exclure certains modules
  },
  "notifier_utilisateur_cible": true
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "message": "Permissions dupliqu√©es avec succ√®s",
    "source": {
      "user_id": "source-user-uuid",
      "identifiant": "john.doe"
    },
    "cible": {
      "user_id": "target-user-uuid",
      "identifiant": "marie.curie"
    },
    "permissions_copiees": {
      "profils": 2,
      "modules_complets": 5,
      "modules_partiels": 2,
      "total_rubriques": 18
    },
    "mode": "fusion",
    "notification": {
      "envoyee": true,
      "destinataire": "marie.curie@hospital.com"
    },
    "duplicated_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "RH"
    },
    "duplicated_at": "2025-01-15T15:30:00Z"
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Mode fusion** : Ajoute sans supprimer l'existant
- **Mode remplacement** : Supprime tout avant copie
- **Filtrage intelligent** : Application filtres avant copie
- **Validation modules** : V√©rification contre licence
- **Performance** : Utilisation COPY FROM pour insertion masse

---

## üîß US-GU-010 : Recherche Avanc√©e

### **GET /api/v1/back-office/users/search**

#### **R√®gles M√©tier**

1. **Multi-crit√®res** : Combinaison complexe de filtres
2. **Full-text search** : Recherche dans tous les champs texte
3. **Suggestions** : Auto-compl√©tion sur identifiants
4. **Export possible** : R√©sultats exportables en CSV/Excel
5. **Sauvegarde recherche** : Possibilit√© de sauvegarder les crit√®res

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Query Parameters**

| Param√®tre         | Type    | Description                   |
| ----------------- | ------- | ----------------------------- |
| q                 | string  | Recherche globale             |
| modules[]         | array   | Modules requis (op√©rateur OR) |
| rubriques[]       | array   | Rubriques requises            |
| profils[]         | array   | Profils requis                |
| has_admin         | boolean | A des droits admin            |
| has_medical       | boolean | A un r√¥le m√©dical             |
| created_after     | date    | Cr√©√© apr√®s cette date         |
| created_before    | date    | Cr√©√© avant cette date         |
| last_login_after  | date    | Derni√®re connexion apr√®s      |
| last_login_before | date    | Derni√®re connexion avant      |
| statuts[]         | array   | Statuts multiples             |
| operator          | string  | AND ou OR entre crit√®res      |

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "users": [
      // Format identique √† GET /users
    ],
    "facettes": {
      "par_statut": {
        "actif": 120,
        "suspendu": 15,
        "expire": 5
      },
      "par_profil": {
        "MEDECIN": 45,
        "INFIRMIER": 60,
        "ADMINISTRATIF": 35
      },
      "par_module": {
        "CONSULTATION": 45,
        "URGENCES": 30,
        "CAISSE": 80
      }
    },
    "suggestions": ["john.doe", "john.smith", "johnny.walker"],
    "recherche_sauvegardable": {
      "criteres": {
        /* crit√®res utilis√©s */
      },
      "hash": "abc123def456"
    },
    "total_results": 140,
    "execution_time_ms": 45
  }
}
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Indexation** : Utilisation GIN index pour full-text search
- **Facettes dynamiques** : Calcul en temps r√©el des distributions
- **Suggestions limit√©es** : Max 10 suggestions
- **Limite r√©sultats** : Max 500 sans pagination

---

## üîß US-GU-011 : Import/Export en Masse

### **POST /api/v1/back-office/users/import**

#### **R√®gles M√©tier**

1. **Formats support√©s** : CSV, Excel (.xlsx)
2. **Validation pr√©alable** : Dry-run avant import r√©el
3. **Gestion erreurs** : Rapport d√©taill√© par ligne
4. **Transaction par batch** : Lots de 100 pour performance
5. **Template fourni** : Endpoint GET pour t√©l√©charger template

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

#### **Request Body (multipart)**

```
file: users.csv
options: {
  "dry_run": false,
  "ignore_errors": false,
  "batch_size": 100,
  "default_password": "TempPass123!",
  "force_password_change": true,
  "default_profil_id": "profil-uuid",
  "send_credentials": true
}
```

#### **Response 200**

```json
{
  "success": true,
  "data": {
    "message": "Import termin√© avec succ√®s",
    "statistiques": {
      "total_lignes": 150,
      "importees": 145,
      "erreurs": 5,
      "ignorees": 0,
      "temps_traitement_secondes": 8.5
    },
    "erreurs": [
      {
        "ligne": 45,
        "identifiant": "invalid.user",
        "erreurs": ["Identifiant d√©j√† existant", "Format t√©l√©phone invalide"]
      }
    ],
    "utilisateurs_crees": [
      {
        "ligne": 1,
        "identifiant": "new.user1",
        "id": "created-uuid-1",
        "credentials_sent": true
      }
    ],
    "import_id": "import-uuid",
    "imported_by": {
      "id": "admin-uuid",
      "nom": "Admin",
      "prenoms": "Import"
    },
    "imported_at": "2025-01-15T15:30:00Z"
  }
}
```

### **GET /api/v1/back-office/users/export**

#### **Query Parameters**

| Param√®tre           | Type    | Description              |
| ------------------- | ------- | ------------------------ |
| format              | string  | csv ou xlsx              |
| include_permissions | boolean | Inclure les permissions  |
| include_profils     | boolean | Inclure les profils      |
| filters             | object  | M√™mes filtres que /users |

#### **Response 200**

```
Content-Type: text/csv
Content-Disposition: attachment; filename="users_export_20250115.csv"

[Contenu CSV]
```

#### **R√®gles M√©tier Sp√©cifiques**

- **Limite export** : Max 10000 lignes par export
- **Colonnes dynamiques** : Selon options choisies
- **Format dates** : ISO 8601
- **Encodage** : UTF-8 avec BOM pour Excel
- **Compression** : ZIP si > 5MB

---

## üìä Requ√™tes SQL Optimis√©es

### GetUsersWithPermissionsSummary

```sql
-- Requ√™te optimis√©e avec CTEs et aggregations
WITH user_profils AS (
    SELECT
        pu.utilisateur_id,
        jsonb_agg(
            jsonb_build_object(
                'id', pt.id,
                'nom_profil', pt.nom_profil,
                'code_profil', pt.code_profil
            ) ORDER BY pt.nom_profil
        ) as profils
    FROM user_profil_utilisateurs pu
    JOIN user_profil_template pt ON pu.profil_template_id = pt.id
    WHERE pu.est_actif = TRUE
    GROUP BY pu.utilisateur_id
),
user_permissions_count AS (
    SELECT
        u.id as user_id,
        COUNT(DISTINCT CASE
            WHEN um.acces_toutes_rubriques OR pm.acces_toutes_rubriques
            THEN COALESCE(um.module_id, pm.module_id)
        END) as modules_complets,
        COUNT(DISTINCT CASE
            WHEN NOT (um.acces_toutes_rubriques OR pm.acces_toutes_rubriques)
            THEN COALESCE(um.module_id, pm.module_id)
        END) as modules_partiels,
        COUNT(DISTINCT COALESCE(umr.rubrique_id, pr.rubrique_id)) as total_rubriques
    FROM user_utilisateur u
    LEFT JOIN user_modules um ON u.id = um.utilisateur_id AND um.est_actif = TRUE
    LEFT JOIN user_modules_rubriques umr ON u.id = umr.utilisateur_id AND umr.est_actif = TRUE
    LEFT JOIN user_profil_utilisateurs pu ON u.id = pu.utilisateur_id AND pu.est_actif = TRUE
    LEFT JOIN user_profil_modules pm ON pu.profil_template_id = pm.profil_template_id AND pm.est_actif = TRUE
    LEFT JOIN user_profil_rubriques pr ON pu.profil_template_id = pr.profil_template_id AND pr.est_actif = TRUE
    WHERE u.etablissement_id = $1
    GROUP BY u.id
)
SELECT
    u.id,
    u.identifiant,
    u.nom,
    u.prenoms,
    u.telephone,
    u.est_admin,
    u.type_admin,
    u.est_medecin,
    u.role_metier,
    u.est_temporaire,
    u.date_expiration,
    u.statut,
    u.last_login_at,
    u.created_at,
    COALESCE(up.profils, '[]'::jsonb) as profils,
    jsonb_build_object(
        'total_modules', COALESCE(upc.modules_complets, 0) + COALESCE(upc.modules_partiels, 0),
        'modules_complets', COALESCE(upc.modules_complets, 0),
        'modules_partiels', COALESCE(upc.modules_partiels, 0),
        'total_rubriques', COALESCE(upc.total_rubriques, 0)
    ) as permissions_resume
FROM user_utilisateur u
LEFT JOIN user_profils up ON u.id = up.utilisateur_id
LEFT JOIN user_permissions_count upc ON u.id = upc.user_id
WHERE u.etablissement_id = $1
    AND ($2::text IS NULL OR u.statut = $2)
    AND ($3::text IS NULL OR u.identifiant ILIKE '%' || $3 || '%'
         OR u.nom ILIKE '%' || $3 || '%'
         OR u.prenoms ILIKE '%' || $3 || '%')
    AND ($4::boolean IS NULL OR u.est_admin = $4)
    AND ($5::boolean IS NULL OR u.est_medecin = $5)
    AND ($6::uuid IS NULL OR EXISTS (
        SELECT 1 FROM user_profil_utilisateurs
        WHERE utilisateur_id = u.id
        AND profil_template_id = $6
        AND est_actif = TRUE
    ))
ORDER BY u.created_at DESC
LIMIT $7 OFFSET $8;
```

---

## üõ°Ô∏è S√©curit√© et Audit

### √âv√©nements √† Logger

1. **Cr√©ation utilisateur** : Log complet avec permissions initiales
2. **Modification permissions** : Diff avant/apr√®s
3. **R√©initialisation mot de passe** : √âv√©nement s√©curit√© critique
4. **D√©sactivation compte** : Avec motif
5. **Import masse** : Nombre et identifiants cr√©√©s
6. **Duplication permissions** : Source et destination

### Format Log Audit

```json
{
  "timestamp": "2025-01-15T15:30:00Z",
  "event_type": "USER_PERMISSION_CHANGE",
  "actor": {
    "id": "admin-uuid",
    "identifiant": "admin.system",
    "ip": "192.168.1.100"
  },
  "target": {
    "id": "user-uuid",
    "identifiant": "john.doe"
  },
  "changes": {
    "before": {
      /* √©tat avant */
    },
    "after": {
      /* √©tat apr√®s */
    }
  },
  "metadata": {
    "establishment_code": "CENTREA",
    "request_id": "req-uuid",
    "user_agent": "Mozilla/5.0..."
  }
}
```

---

## ‚ö° Optimisations Performance

1. **Index composites** : (etablissement_id, statut, created_at)
2. **Pagination obligatoire** : Limite max 100
3. **Projection s√©lective** : SELECT uniquement colonnes n√©cessaires
4. **Batch operations** : INSERT/UPDATE par lots de 100
5. **Connection pooling** : R√©utilisation connexions PostgreSQL

---

## ‚úÖ Checklist Impl√©mentation

### Endpoints Principaux

- [x] GET /api/v1/back-office/users - Liste avec filtres
- [x] GET /api/v1/back-office/users/{id} - D√©tails complets
- [x] POST /api/v1/back-office/users - Cr√©ation avec permissions
- [ ] PUT /api/v1/back-office/users/{id} - Modification infos
- [ ] DELETE /api/v1/back-office/users/{id} - Archivage

### Gestion Permissions

- [ ] GET /api/v1/back-office/users/{id}/permissions - Vue consolid√©e
- [x] PUT /api/v1/back-office/users/{id}/permissions - Modification delta
- [ ] POST /api/v1/back-office/users/{id}/duplicate-permissions - Copie

### Fonctionnalit√©s Avanc√©es

- [ ] POST /api/v1/back-office/users/{id}/reset-password
- [ ] GET /api/v1/back-office/users/search - Recherche avanc√©e
- [ ] POST /api/v1/back-office/users/import - Import CSV/Excel
- [ ] GET /api/v1/back-office/users/export - Export donn√©es
- [ ] GET /api/v1/back-office/users/template - Template import

### Infrastructure

- [ ] Service Layer avec validation m√©tier
- [ ] Queries PostgreSQL optimis√©es
- [ ] Validation multi-tenant pour modules front-office
- [ ] Audit trail complet
- [ ] Tests unitaires et int√©gration

---

**Cette sp√©cification garantit un syst√®me de gestion des comptes utilisateurs robuste, performant et maintenable, avec une flexibilit√© maximale pour l'attribution des permissions tout en restant simple d'utilisation.**
