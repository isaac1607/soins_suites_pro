# SP√âCIFICATIONS TECHNIQUES - MODULE AUTHENTIFICATION

## üìã Informations G√©n√©rales

- **Module :** Authentification & Gestion des Sessions
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Services ‚Üí Queries ‚Üí DB (PostgreSQL + Redis)

## üéØ Objectif

D√©velopper un syst√®me d'authentification multi-tenant robuste avec :

- Tokens opaques UUID stock√©s dans Redis
- Syst√®me de permissions √† 3 niveaux (Profils ‚Üí Modules ‚Üí Rubriques)
- Distinction stricte Back-Office / Front-Office
- Fallback PostgreSQL pour continuit√© de service

## üèóÔ∏è Architecture Technique

```
internal/modules/auth/
‚îú‚îÄ‚îÄ auth.module.go              # Module Fx
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ auth.controller.go      # Login/Logout/Me
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.go         # Logique authentification
‚îÇ   ‚îú‚îÄ‚îÄ session.service.go      # Gestion sessions Redis/PostgreSQL
‚îÇ   ‚îî‚îÄ‚îÄ permission.service.go   # Gestion permissions
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ auth.dto.go            # Types Request/Response
‚îî‚îÄ‚îÄ queries/
    ‚îú‚îÄ‚îÄ user.postgres.go        # Requ√™tes utilisateurs
    ‚îî‚îÄ‚îÄ permission.postgres.go  # Requ√™tes permissions
```

## üîß API Endpoints

### **POST /api/v1/auth/login**

#### **Description**

Authentification utilisateur avec retour des permissions compl√®tes

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
X-Client-Type: front-office  # ou back-office
Content-Type: application/json
```

#### **Request Body**

```json
{
  "identifiant": "john.doe",
  "password": "SecurePass123!"
}
```

#### **Response 200 - Success**

```json
{
  "success": true,
  "data": {
    "token": "a1b2c3d4-e5f6-47h8-89i9-j0k1l2m3n4o5",
    "expires_at": "2025-01-15T15:30:00Z",
    "front_office": false,
    "back_office": true,
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "identifiant": "admin.system",
      "nom": "COULIBALY",
      "prenoms": "Drissa",
      "telephone": "0612345678",
      "est_admin": true,
      "type_admin": "super_admin",
      "est_admin_tir": false,
      "must_change_password": false,
      "est_medecin": false,
      "role_metier": null
    },
    "permissions": [
      {
        "code_module": "ETABLISSEMENTS",
        "nom_standard": "Gestion des √©tablissements",
        "nom_personnalise": null,
        "description": "Module de gestion compl√®te des √©tablissements",
        "rubriques": [] // Vide = acc√®s √† TOUTES les rubriques
      },
      {
        "code_module": "USERS",
        "nom_standard": "Gestion des utilisateurs",
        "nom_personnalise": "Utilisateurs & Permissions",
        "description": "Module de gestion des utilisateurs et leurs permissions",
        "rubriques": [
          // Liste = acc√®s RESTREINT √† ces rubriques uniquement
          {
            "code_rubrique": "CREATE_USER",
            "nom": "Cr√©er un utilisateur",
            "description": "Permet la cr√©ation de nouveaux utilisateurs",
            "ordre_affichage": 1
          },
          {
            "code_rubrique": "VIEW_USER",
            "nom": "Consulter les utilisateurs",
            "description": "Permet la consultation des utilisateurs",
            "ordre_affichage": 2
          }
        ]
      },
      {
        "code_module": "CAISSE",
        "nom_standard": "Caisse",
        "nom_personnalise": null,
        "description": "Module de gestion de la caisse",
        "rubriques": [] // Acc√®s complet
      }
    ],
    "setup": {
      // Uniquement pour back-office
      "est_termine": false,
      "etape_actuelle": 1,
      "total_etapes": 5
    }
  }
}
```

#### **Response 401 - Identifiants Incorrects**

```json
{
  "error": "Identifiant ou mot de passe incorrect",
  "details": {
    "code": "INVALID_CREDENTIALS",
    "attempts_remaining": 3
  }
}
```

#### **Response 403 - Type Client Incorrect**

```json
{
  "error": "Acc√®s refus√© √† cette interface",
  "details": {
    "code": "CLIENT_TYPE_MISMATCH",
    "reason": "Compte administrateur requis pour le back-office"
  }
}
```

#### **Response 429 - Rate Limit**

```json
{
  "error": "Trop de tentatives de connexion",
  "details": {
    "code": "RATE_LIMIT_EXCEEDED",
    "retry_after_seconds": 900
  }
}
```

#### **R√®gles M√©tier**

1. **Validation √âtablissement** : Via EstablishmentMiddleware (header obligatoire)
2. **Coh√©rence Client Type** :
   - `back-office` ‚Üí `est_admin = true` requis
   - `front-office` ‚Üí `est_admin = false` requis
3. **Rate Limiting** : Max 5 tentatives par 15 minutes par identifiant
4. **Token Format** : UUID v4 (36 caract√®res)
5. **Session TTL** : 1 heure
6. **Permissions Structur√©es** :
   - `rubriques: []` ‚Üí Acc√®s complet au module
   - `rubriques: [...]` ‚Üí Acc√®s restreint aux rubriques list√©es
7. **Setup Info** : Retourn√© uniquement pour back-office

#### **Processus Interne**

```mermaid
sequenceDiagram
    participant Client
    participant API
    participant Redis
    participant PostgreSQL

    Client->>API: POST /auth/login
    API->>PostgreSQL: Validate credentials
    API->>PostgreSQL: Get user permissions
    API->>Redis: Create session
    API->>Redis: Cache permissions
    API-->>Client: Token + Permissions
```

---

### **POST /api/v1/auth/logout**

#### **Description**

D√©connexion utilisateur avec r√©vocation imm√©diate de la session

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200 - Success**

```json
{
  "success": true,
  "message": "D√©connexion r√©ussie"
}
```

#### **Response 401 - Token Invalide**

```json
{
  "error": "Session invalide ou expir√©e",
  "details": {
    "code": "INVALID_TOKEN"
  }
}
```

#### **R√®gles M√©tier**

1. **Suppression Redis** : Session supprim√©e imm√©diatement
2. **Suppression Index** : Token retir√© de l'index utilisateur
3. **Audit Log** : √âv√©nement logout trac√©
4. **Idempotent** : Logout multiple sur m√™me token = succ√®s

---

### **GET /api/v1/auth/me**

#### **Description**

R√©cup√©ration des informations utilisateur courant et permissions

#### **Headers Requis**

```http
X-Establishment-Code: CENTREA
Authorization: Bearer {token}
```

#### **Response 200 - Success**

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "identifiant": "john.doe",
      "nom": "DOE",
      "prenoms": "John",
      "telephone": "0612345678",
      "est_admin": false,
      "est_medecin": true,
      "role_metier": "M√©decin g√©n√©raliste"
    },
    "permissions": [
      {
        "code_module": "CONSULTATION",
        "nom_standard": "Consultation",
        "nom_personnalise": null,
        "description": "Module de consultation m√©dicale",
        "rubriques": [] // Acc√®s complet
      }
    ],
    "session": {
      "token": "current-token-uuid",
      "expires_at": "2025-01-15T15:30:00Z",
      "client_type": "front-office"
    }
  }
}
```

---

## üóÑÔ∏è Sch√©mas Redis

### **Session**

```
Cl√© : soins_suite_{etablissement}_auth_session:{token}
TTL : 3600s
Type : HASH

Champs :
{
  "user_id": "uuid",
  "etablissement_id": "uuid",
  "etablissement_code": "CENTREA",
  "client_type": "front-office|back-office",
  "ip_address": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "created_at": "2025-01-15T14:30:00Z",
  "last_activity": "2025-01-15T14:45:00Z"
}
```

### **Permissions Cache**

```
Cl√© : soins_suite_{etablissement}_auth_permissions:{user_id}
TTL : 3600s
Type : SET

Membres :
- module:CONSULTATION
- module:CAISSE
- rubrique:USERS:CREATE_USER
- rubrique:USERS:VIEW_USER
```

### **Rate Limiting**

```
Cl√© : soins_suite_{etablissement}_auth_ratelimit:{identifiant}
TTL : 900s
Type : STRING

Valeur : "5"  // Nombre de tentatives
```

---

## üìä Requ√™tes SQL

### **GetUserWithPermissions**

```sql
WITH user_modules_access AS (
    -- Modules via profils
    SELECT DISTINCT
        m.id, m.code_module, m.nom_standard, m.nom_personnalise,
        m.description, pm.acces_toutes_rubriques, 'profil' as source
    FROM user_profil_utilisateurs pu
    JOIN user_profil_modules pm ON pm.profil_template_id = pu.profil_template_id
    JOIN base_module m ON m.id = pm.module_id
    WHERE pu.utilisateur_id = $1 AND pu.est_actif = TRUE

    UNION

    -- Modules directs
    SELECT DISTINCT
        m.id, m.code_module, m.nom_standard, m.nom_personnalise,
        m.description, um.acces_toutes_rubriques, 'direct' as source
    FROM user_modules um
    JOIN base_module m ON m.id = um.module_id
    WHERE um.utilisateur_id = $1 AND um.est_actif = TRUE
),
user_rubriques_access AS (
    -- Rubriques via profils
    SELECT pr.module_id, r.id, r.code_rubrique, r.nom,
           r.description, r.ordre_affichage
    FROM user_profil_utilisateurs pu
    JOIN user_profil_rubriques pr ON pr.profil_template_id = pu.profil_template_id
    JOIN base_rubrique r ON r.id = pr.rubrique_id
    WHERE pu.utilisateur_id = $1 AND pu.est_actif = TRUE

    UNION

    -- Rubriques directes
    SELECT umr.module_id, r.id, r.code_rubrique, r.nom,
           r.description, r.ordre_affichage
    FROM user_modules_rubriques umr
    JOIN base_rubrique r ON r.id = umr.rubrique_id
    WHERE umr.utilisateur_id = $1 AND umr.est_actif = TRUE
)
SELECT
    m.code_module,
    m.nom_standard,
    m.nom_personnalise,
    m.description,
    CASE
        WHEN bool_or(m.acces_toutes_rubriques) THEN '[]'::jsonb
        ELSE jsonb_agg(
            DISTINCT jsonb_build_object(
                'code_rubrique', r.code_rubrique,
                'nom', r.nom,
                'description', r.description,
                'ordre_affichage', r.ordre_affichage
            ) ORDER BY r.ordre_affichage
        ) FILTER (WHERE r.id IS NOT NULL)
    END as rubriques
FROM user_modules_access m
LEFT JOIN user_rubriques_access r ON r.module_id = m.id
    AND NOT bool_or(m.acces_toutes_rubriques)
GROUP BY m.code_module, m.nom_standard, m.nom_personnalise, m.description
ORDER BY m.code_module;
```

---

## ‚ö° R√®gles de Performance

1. **Cache First** : Toujours v√©rifier Redis avant PostgreSQL
2. **Pipeline Redis** : Op√©rations group√©es pour login
3. **Permissions en SET** : V√©rification O(1) avec SISMEMBER
4. **TTL Coh√©rents** : Session et permissions = 1h
5. **Fallback PostgreSQL** : Table `user_session` si Redis down

---

## üõ°Ô∏è S√©curit√©

1. **Hashage** : bcrypt avec cost 12 + salt unique
2. **Tokens** : UUID v4 crypto-secure
3. **Rate Limiting** : 5 tentatives / 15 minutes
4. **Isolation** : Multi-tenant strict par √©tablissement
5. **Audit** : Tous les √©v√©nements auth trac√©s

---

## ‚úÖ Checklist Impl√©mentation

- [ ] **AuthController** : 3 endpoints (login, logout, me)
- [ ] **AuthService** : Validation credentials + g√©n√©ration token
- [ ] **SessionService** : CRUD sessions Redis + fallback PostgreSQL
- [ ] **PermissionService** : Aggregation permissions + cache
- [ ] **Queries PostgreSQL** : Requ√™tes optimis√©es avec CTEs
- [ ] **Redis Integration** : Sessions + permissions + rate limit
- [ ] **Middlewares** :
  - [ ] SessionMiddleware : Validation token
  - [ ] PermissionMiddleware : Contr√¥le acc√®s
- [ ] **Tests** : Unitaires + int√©gration + charge
- [ ] **Documentation** : OpenAPI/Swagger

---

## üìù Notes d'Impl√©mentation

### **Gestion des Erreurs**

```go
type AuthError struct {
    Code    string `json:"code"`
    Message string `json:"message"`
    Details map[string]interface{} `json:"details,omitempty"`
}
```

### **Context Enrichi**

```go
// Dans gin.Context apr√®s auth
session := c.MustGet("session").(SessionContext)
permissions := c.MustGet("permissions").([]string)
```

### **Validation Permissions**

```go
// Middleware pour routes prot√©g√©es
router.GET("/api/v1/users",
    SessionMiddleware(),
    PermissionMiddleware("module:USERS"),
    controller.GetUsers,
)
```

---

**Ces sp√©cifications garantissent un syst√®me d'authentification robuste, performant et maintenable pour Soins Suite.**
