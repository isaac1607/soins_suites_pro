# SP√âCIFICATIONS TECHNIQUES - CORE-SERVICE PATIENT

## üìã Informations G√©n√©rales

- **Module :** Core-Service Patient (Services M√©tier Centralis√©s)
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Service partag√© mono-tenant pour donn√©es patient unifi√©es

## üéØ Vision & Objectifs

### Vision Strat√©gique

**Cr√©er un r√©f√©rentiel patient unique et centralis√©** permettant :

- **Identification unique** : Un patient = Un code, valable dans tous les √©tablissements
- **Z√©ro duplication** : √âviter la recr√©ation de fiches patients entre √©tablissements
- **Portabilit√©** : Le patient conserve son identifiant m√©dical √† vie
- **Isolation m√©dicale** : Les donn√©es m√©dicales restent isol√©es par √©tablissement
- **Partage contr√¥l√©** : Autorisation explicite pour partage inter-√©tablissements

### Objectifs Techniques

1. **Unicit√© garantie** : Code patient unique au niveau national
2. **Performance** : Recherche < 50ms sur 10M+ patients
3. **Int√©grit√©** : Donn√©es patient coh√©rentes et valid√©es
4. **Tra√ßabilit√©** : Audit complet cr√©ation/modification
5. **Cache intelligent** : Redis pour acc√®s ultra-rapide

---

## üóÑÔ∏è MOD√àLE DE DONN√âES POSTGRESQL

### Tables de R√©f√©rence (Nomenclatures)

```sql
-- TABLES DE R√âF√âRENCE (NOMENCLATURES)
-- =====================================
-- Description : Tables partag√©es entre tous les √©tablissements

-- Nationalit√©s
CREATE TABLE ref_nationalite (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(3) NOT NULL,  -- Code ISO Alpha-3 (CIV, FRA, etc.)
    nom VARCHAR(100) NOT NULL,
    est_actif BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT UQ_ref_nationalite_code UNIQUE (code),
    CONSTRAINT UQ_ref_nationalite_nom UNIQUE (nom)
);

-- Situations matrimoniales
CREATE TABLE ref_situation_matrimoniale (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(20) NOT NULL,  -- CELIBATAIRE, MARIE, DIVORCE, VEUF
    nom VARCHAR(50) NOT NULL,
    ordre_affichage INTEGER DEFAULT 0,
    est_actif BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT UQ_ref_situation_matrimoniale_code UNIQUE (code),
    CONSTRAINT UQ_ref_situation_matrimoniale_nom UNIQUE (nom)
);

-- Types de pi√®ces d'identit√©
CREATE TABLE ref_type_piece_identite (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(20) NOT NULL,  -- CNI, PASSPORT, ATTESTATION, etc.
    nom VARCHAR(100) NOT NULL,
    ordre_affichage INTEGER DEFAULT 0,
    est_actif BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT UQ_ref_type_piece_identite_code UNIQUE (code),
    CONSTRAINT UQ_ref_type_piece_identite_nom UNIQUE (nom)
);

-- Professions
CREATE TABLE ref_profession (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(50) NOT NULL,
    nom VARCHAR(150) NOT NULL,
    categorie VARCHAR(50),  -- SANTE, EDUCATION, COMMERCE, etc.
    est_actif BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT UQ_ref_profession_code UNIQUE (code),
    CONSTRAINT UQ_ref_profession_nom UNIQUE (nom)
);

-- Liens de parent√© / Affiliations
CREATE TABLE ref_affiliation (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(20) NOT NULL,  -- PERE, MERE, CONJOINT, ENFANT, TUTEUR
    nom VARCHAR(50) NOT NULL,
    ordre_affichage INTEGER DEFAULT 0,
    est_actif BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT UQ_ref_affiliation_code UNIQUE (code),
    CONSTRAINT UQ_ref_affiliation_nom UNIQUE (nom)
);

-- =====================================
-- TABLE PRINCIPALE : PATIENTS_PATIENT
-- =====================================
-- Description : R√©f√©rentiel patient unique (mono-tenant pour l'identification)

CREATE TABLE patients_patient (
    -- Cl√© primaire
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- IDENTIFICATION UNIQUE
    code_patient VARCHAR(20) NOT NULL,  -- Unique
    etablissement_createur_id UUID NOT NULL,  -- Tra√ßabilit√© cr√©ation

    -- ==========================================
    -- SECTION 1: IDENTIT√â (Obligatoires)
    -- ==========================================
    nom VARCHAR(255) NOT NULL,
    prenoms VARCHAR(255) NOT NULL,
    date_naissance DATE NOT NULL,
    est_date_supposee BOOLEAN DEFAULT FALSE NOT NULL,
    sexe CHAR(1) NOT NULL,
    nationalite_id UUID NOT NULL,
    situation_matrimoniale_id UUID NOT NULL,

    -- Pi√®ce d'identit√© (Optionnels mais recommand√©s)
    type_piece_identite_id UUID,
    cni_nni VARCHAR(100),
    numero_piece_identite VARCHAR(100),

    -- Compl√©ment identit√© (Optionnels)
    lieu_naissance VARCHAR(255),
    nom_jeune_fille VARCHAR(255),  -- Pour les femmes mari√©es

    -- ==========================================
    -- SECTION 2: CONTACT & LOCALISATION
    -- ==========================================
    telephone_principal VARCHAR(20) NOT NULL,
    telephone_secondaire VARCHAR(20),
    email VARCHAR(255),

    -- Adresse
    adresse_complete TEXT NOT NULL,
    quartier VARCHAR(100),
    ville VARCHAR(100),
    commune VARCHAR(100),
    pays_residence VARCHAR(100) DEFAULT 'C√¥te d''Ivoire',

    -- Informations socio-professionnelles
    profession_id UUID,

    -- ==========================================
    -- SECTION 3: PERSONNES √Ä CONTACTER
    -- ==========================================
    personnes_a_contacter JSONB DEFAULT '[]'::jsonb NOT NULL,
    /* Structure JSON valid√©e:
    [
        {
            "nom_prenoms": "Marie KOUADIO",
            "telephone": "+225 07 98 76 54 32",
            "telephone_secondaire": "+225 01 23 45 67 89",
            "affiliation_id": "uuid-ref-affiliation",
        }
    ]
    */

    -- ==========================================
    -- SECTION 4: ASSURANCE & COUVERTURE
    -- ==========================================
    est_assure BOOLEAN DEFAULT FALSE NOT NULL,
    -- Les d√©tails d'assurance sont dans patients_patient_assurance

    -- ==========================================
    -- STATUT & M√âTADONN√âES
    -- ==========================================
    statut VARCHAR(20) DEFAULT 'actif' NOT NULL,

    -- Flags sp√©ciaux
    est_decede BOOLEAN DEFAULT FALSE,
    date_deces DATE,

    -- Recherche & matching
    search_vector tsvector,  -- Pour recherche full-text PostgreSQL

    -- M√©tadonn√©es standards
    created_at TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW() NOT NULL,
    created_by UUID,
    updated_by UUID,

    -- ==========================================
    -- CONTRAINTES UNIQUE
    -- ==========================================
    CONSTRAINT UQ_patients_patient_code_patient UNIQUE (code_patient),

    -- ==========================================
    -- CONTRAINTES FOREIGN KEY
    -- ==========================================
    CONSTRAINT FK_patients_patient_etablissement_createur FOREIGN KEY (etablissement_createur_id)
        REFERENCES base_etablissement(id),
    CONSTRAINT FK_patients_patient_nationalite FOREIGN KEY (nationalite_id)
        REFERENCES ref_nationalite(id),
    CONSTRAINT FK_patients_patient_situation_matrimoniale FOREIGN KEY (situation_matrimoniale_id)
        REFERENCES ref_situation_matrimoniale(id),
    CONSTRAINT FK_patients_patient_type_piece_identite FOREIGN KEY (type_piece_identite_id)
        REFERENCES ref_type_piece_identite(id),
    CONSTRAINT FK_patients_patient_profession FOREIGN KEY (profession_id)
        REFERENCES ref_profession(id),
    CONSTRAINT FK_patients_patient_created_by FOREIGN KEY (created_by)
        REFERENCES user_utilisateur(id),
    CONSTRAINT FK_patients_patient_updated_by FOREIGN KEY (updated_by)
        REFERENCES user_utilisateur(id),

    -- ==========================================
    -- CONTRAINTES CHECK
    -- ==========================================
    CONSTRAINT CK_patients_patient_sexe CHECK (sexe IN ('M', 'F')),
    CONSTRAINT CK_patients_patient_statut CHECK (statut IN ('actif', 'inactif', 'decede', 'archive')),
    CONSTRAINT CK_patients_patient_date_naissance CHECK (date_naissance <= CURRENT_DATE),
    CONSTRAINT CK_patients_patient_date_naissance_realiste CHECK (
        date_naissance >= '1900-01-01' AND
        date_naissance <= CURRENT_DATE
    ),
    CONSTRAINT CK_patients_patient_telephone_format CHECK (
        telephone_principal ~ '^[+0-9 ()-]+$'
    ),
    CONSTRAINT CK_patients_patient_email_format CHECK (
        email IS NULL OR email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
    ),
    CONSTRAINT CK_patients_patient_coherence_deces CHECK (
        (est_decede = FALSE AND date_deces IS NULL) OR
        (est_decede = TRUE AND date_deces IS NOT NULL)
    )
);

-- =====================================
-- TABLE : PATIENTS_PATIENT_ASSURANCE
-- =====================================
-- Description : Association patient-assurance (plusieurs assurances possibles)

CREATE TABLE patients_patient_assurance (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    patient_id UUID NOT NULL,
    assurance_id UUID NOT NULL,

    -- Num√©ro d'assur√© du patient actuel
    numero_assure VARCHAR(100) NOT NULL,  -- Ex: "MUGEF-2024-12345"

    -- Type de b√©n√©ficiaire
    type_beneficiaire VARCHAR(30) DEFAULT 'principal', -- principal, ayant_droit

    -- Si ayant_droit, r√©f√©rence vers l'assur√© principal
    numero_assure_principal VARCHAR(100),  -- Ex: "MUGEF-2024-00001" (le parent/conjoint/enfant,autre)
    lien_avec_principal VARCHAR(50),       -- conjoint, enfant, parent, autre

    -- Statut
    est_actif BOOLEAN DEFAULT TRUE,
    motif_inactivation VARCHAR(255),

    -- M√©tadonn√©es
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by UUID,

    -- ==========================================
    -- CONTRAINTES UNIQUE
    -- ==========================================
    CONSTRAINT UQ_patients_patient_assurance_patient_assurance_actif
        UNIQUE (patient_id, assurance_id, est_actif),

    -- ==========================================
    -- CONTRAINTES FOREIGN KEY
    -- ==========================================
    CONSTRAINT FK_patients_patient_assurance_patient FOREIGN KEY (patient_id)
        REFERENCES patients_patient(id) ON DELETE CASCADE,
    CONSTRAINT FK_patients_patient_assurance_assurance FOREIGN KEY (assurance_id)
        REFERENCES base_assurance(id),
    CONSTRAINT FK_patients_patient_assurance_created_by FOREIGN KEY (created_by)
        REFERENCES user_utilisateur(id),

    -- ==========================================
    -- CONTRAINTES CHECK
    -- ==========================================
    CONSTRAINT CK_patients_patient_assurance_type_beneficiaire
        CHECK (type_beneficiaire IN ('principal', 'ayant_droit')),
    CONSTRAINT CK_patients_patient_assurance_lien_avec_principal
        CHECK (lien_avec_principal IN ('conjoint', 'enfant', 'parent', 'autre')),
    CONSTRAINT CK_patients_patient_assurance_coherence_ayant_droit
        CHECK (
            (type_beneficiaire = 'principal' AND numero_assure_principal IS NULL AND lien_avec_principal IS NULL) OR
            (type_beneficiaire = 'ayant_droit' AND numero_assure_principal IS NOT NULL AND lien_avec_principal IS NOT NULL)
        )
);


-- =====================================
-- INDEXES CRITIQUES (Maximum 5)
-- =====================================
-- Choix optimis√© selon r√®gle 80/20 pour minimiser les co√ªts

-- 1. RECHERCHE PAR CODE (95% des acc√®s - CRITIQUE)
CREATE UNIQUE INDEX IDX_patients_patient_code_patient
    ON patients_patient (code_patient);

-- 2. RECHERCHE FULL-TEXT (Recherche intelligente - CRITIQUE)
CREATE INDEX IDX_patients_patient_search_vector
    ON patients_patient USING gin (search_vector);

-- 3. RECHERCHE PAR T√âL√âPHONE (60% urgences - IMPORTANT)
CREATE INDEX IDX_patients_patient_telephone
    ON patients_patient (telephone_principal);

-- 4. PATIENTS ACTIFS (Majorit√© requ√™tes - IMPORTANT)
CREATE INDEX IDX_patients_patient_statut_actif
    ON patients_patient (statut) WHERE statut = 'actif';

-- 5. RECHERCHE TEXTUELLE FALLBACK (Si search_vector √©choue - FALLBACK)
CREATE INDEX IDX_patients_patient_nom_prenoms_trigram
    ON patients_patient USING gin (nom gin_trgm_ops, prenoms gin_trgm_ops);

-- =====================================
-- TRIGGERS
-- =====================================

-- Trigger pour updated_at automatique
CREATE TRIGGER trigger_patients_patient_updated_at
    BEFORE UPDATE ON patients_patient
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_patients_patient_assurance_updated_at
    BEFORE UPDATE ON patients_patient_assurance
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_ref_nationalite_updated_at
    BEFORE UPDATE ON ref_nationalite
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_ref_situation_matrimoniale_updated_at
    BEFORE UPDATE ON ref_situation_matrimoniale
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_ref_type_piece_identite_updated_at
    BEFORE UPDATE ON ref_type_piece_identite
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_ref_profession_updated_at
    BEFORE UPDATE ON ref_profession
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_ref_affiliation_updated_at
    BEFORE UPDATE ON ref_affiliation
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Trigger pour search_vector (recherche full-text)
CREATE OR REPLACE FUNCTION update_patient_search_vector() RETURNS trigger AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('french', COALESCE(NEW.nom, '')), 'A') ||
        setweight(to_tsvector('french', COALESCE(NEW.prenoms, '')), 'A') ||
        setweight(to_tsvector('french', COALESCE(NEW.code_patient, '')), 'A') ||
        setweight(to_tsvector('french', COALESCE(NEW.telephone_principal, '')), 'B') ||
        setweight(to_tsvector('french', COALESCE(NEW.cni_nni, '')), 'B') ||
        setweight(to_tsvector('french', COALESCE(NEW.numero_piece_identite, '')), 'B');
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_patients_patient_search_vector
    BEFORE INSERT OR UPDATE ON patients_patient
    FOR EACH ROW
    EXECUTE FUNCTION update_patient_search_vector();

-- =====================================
-- COMMENTAIRES DOCUMENTATION
-- =====================================

COMMENT ON TABLE patients_patient IS 'R√©f√©rentiel patient unique - Un patient = Un code valable partout';
COMMENT ON COLUMN patients_patient.code_patient IS 'Code unique format: CI-YYYYMMDD-XXXXX';
COMMENT ON COLUMN patients_patient.etablissement_createur_id IS '√âtablissement ayant cr√©√© le patient (tra√ßabilit√©)';
COMMENT ON COLUMN patients_patient.search_vector IS 'Vecteur de recherche full-text pour recherche rapide';
COMMENT ON COLUMN patients_patient.personnes_a_contacter IS 'Liste JSON des contacts d''urgence avec priorit√©';
COMMENT ON COLUMN patients_patient.est_date_supposee IS 'TRUE si date de naissance approximative';

COMMENT ON TABLE patients_patient_assurance IS 'Association patient-assurance avec support multi-assurances';
COMMENT ON COLUMN patients_patient_assurance.type_beneficiaire IS 'principal ou ayant_droit (enfant, conjoint, etc.)';
COMMENT ON COLUMN patients_patient_assurance.numero_assure_principal IS 'Num√©ro de l''assur√© principal si ayant_droit';

COMMENT ON TABLE ref_nationalite IS 'R√©f√©rentiel des nationalit√©s (codes ISO Alpha-3)';
COMMENT ON TABLE ref_situation_matrimoniale IS 'R√©f√©rentiel des situations matrimoniales';
COMMENT ON TABLE ref_type_piece_identite IS 'R√©f√©rentiel des types de pi√®ces d''identit√©';
COMMENT ON TABLE ref_profession IS 'R√©f√©rentiel des professions par cat√©gorie';
COMMENT ON TABLE ref_affiliation IS 'R√©f√©rentiel des liens de parent√© pour personnes √† contacter';
```

---

## üî¥ SCH√âMA REDIS - CACHE MINIMALISTE

### Convention de Nommage Simplifi√©e

**Approche minimaliste** : Une seule cl√© Redis pour couvrir 95% des cas d'usage.

```
soins_suite_patient:{code_patient}
```

**Note importante** : Pas de code √©tablissement car le r√©f√©rentiel patient est **mono-tenant** pour l'identification.

### 1Ô∏è‚É£ Cache Patient Unique (SEULE CL√â)

```
Cl√© : soins_suite_patient:{code_patient}
Type : HASH
TTL : 3600s (1 heure)

Contenu :
{
    "id": "uuid-patient",
    "code_patient": "CI-20240115-00001",
    "nom": "KOUADIO",
    "prenoms": "Jean Baptiste",
    "date_naissance": "1985-06-15",
    "sexe": "M",
    "telephone_principal": "+225 07 12 34 56 78",
    "adresse_complete": "Cocody, Angr√© 8√®me tranche",
    "est_assure": "true",
    "etablissement_createur_id": "uuid-etablissement",
    "statut": "actif",
    "created_at": "2024-01-15T10:00:00Z",
    "updated_at": "2024-01-15T14:30:00Z",

    // Donn√©es assurances incluses directement
    "assurances": '[{"id": "uuid", "nom": "MUGEF-CI", "numero": "123456"}]'
}
```

---

## üìä STRAT√âGIE DE CACHE MINIMALISTE

### Hi√©rarchie Simplifi√©e

1. **Redis Cache** (< 1ms) - 95% des acc√®s directs par code_patient
2. **PostgreSQL** (< 50ms) - Source de v√©rit√© avec search_vector pour recherches

### Invalidation Cache Simplifi√©e

#### √âv√©nement d√©clencheur unique :

- **Modification patient** ‚Üí Invalider `soins_suite_patient:{code_patient}`

#### Pattern d'invalidation minimaliste :

```go
// Invalidation simple - 1 seule cl√©
func InvalidatePatientCache(ctx context.Context, codePatient string) error {
    key := fmt.Sprintf("soins_suite_patient:%s", codePatient)
    return redis.Del(ctx, key).Err()
}
```

### Logique M√©tier Simplifi√©e

```go
// 1. Recherche par code (95% des cas)
patient := redis.HGetAll("soins_suite_patient:" + code)

// 2. Recherche par t√©l√©phone/nom (5% des cas)
// ‚Üí Direct PostgreSQL avec search_vector
// ‚Üí Pas de cache (complexit√© non justifi√©e)

// 3. Cr√©ation patient
// ‚Üí Ins√©rer en DB + warming cache imm√©diat
redis.HMSet("soins_suite_patient:" + code, patientData)
```

---

## üîí R√àGLES M√âTIER CRITIQUES

### Unicit√© du Code Patient

### Gestion des Doublons

### Protection des Donn√©es

### Coh√©rence Multi-√âtablissement

1. **Lecture** : Tous les √©tablissements peuvent lire
2. **Modification** : Tout √©tablissement peut modifier (avec tra√ßabilit√©)
3. **Historique** : Conserv√© par √©tablissement modificateur
4. **Conflits** : R√©solution par timestamp (last write wins)

---

## ‚ö° OPTIMISATIONS PERFORMANCE

### Index PostgreSQL

| Index                     | Justification                | Gain Estim√©   |
| ------------------------- | ---------------------------- | ------------- |
| `code_patient`            | Recherche principale (95%)   | 50ms ‚Üí 1ms    |
| `nom + prenoms (trigram)` | Recherche textuelle (80%)    | 500ms ‚Üí 20ms  |
| `telephone_principal`     | Identification urgence (60%) | 300ms ‚Üí 15ms  |
| `date_naissance`          | Filtre √¢ge/anniversaire      | 200ms ‚Üí 10ms  |
| `search_vector (GIN)`     | Full-text search             | 1000ms ‚Üí 50ms |

### Strat√©gies Query

1. **Pagination obligatoire** : Max 50 r√©sultats par page
2. **Projection s√©lective** : SELECT uniquement champs n√©cessaires
3. **Eager loading** : Pr√©charger assurances si `est_assure = true`
4. **Query parall√®le** : Donn√©es patient + assurances en parall√®le

### M√©triques Cibles

- **Cr√©ation patient** : < 100ms (avec v√©rification doublons)
- **Recherche code** : < 10ms (cache) / < 50ms (DB)
- **Recherche nom** : < 100ms pour 10M patients
- **Modification** : < 50ms + invalidation cache
- **D√©tection doublons** : < 500ms par patient

---

## üîß POINTS D'ATTENTION POUR L'IMPL√âMENTATION

### Validation Donn√©es

```go
// Validations critiques c√¥t√© service
type PatientValidator struct {
    // Format t√©l√©phone C√¥te d'Ivoire
    PhoneRegex = regexp.MustCompile(`^(\+225|00225)?[0-9]{10}$`)

    // Email valide
    EmailRegex = regexp.MustCompile(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)

    // Code patient
    CodeRegex = regexp.MustCompile(`^CI-\d{8}-\d{5}$`)
}
```

### Gestion Transactions

```go
// Transaction pour cr√©ation avec v√©rification doublon
func CreatePatient(ctx context.Context, data PatientDTO) error {
    tx, _ := db.BeginTx(ctx, nil)
    defer tx.Rollback()

    // 1. Lock Redis anti-doublon
    lockKey := generateLockKey(data)
    if !acquireLock(lockKey) {
        return ErrPatientCreationInProgress
    }
    defer releaseLock(lockKey)

    // 2. V√©rifier doublons
    if doublon := checkDoublon(tx, data); doublon != nil {
        return ErrPatientDoublonDetecte
    }

    // 3. G√©n√©rer code patient
    code := generatePatientCode(tx)

    // 4. Ins√©rer patient
    patient := insertPatient(tx, code, data)

    // 5. Historique
    insertHistorique(tx, patient, "CREATION")

    // 6. Commit
    tx.Commit()

    // 7. Cache warming
    warmCache(patient)

    return nil
}
```

### Architecture Core-Service

```
internal/modules/core-services/patient/
‚îú‚îÄ‚îÄ patient-core.module.go
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ patient-creation.service.go      # Cr√©ation avec anti-doublon
‚îÇ   ‚îú‚îÄ‚îÄ patient-search.service.go        # Recherche multi-crit√®res
‚îÇ   ‚îú‚îÄ‚îÄ patient-validation.service.go    # Validations m√©tier
‚îÇ   ‚îî‚îÄ‚îÄ patient-cache.service.go         # Gestion cache Redis
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ patient-core.dto.go
‚îÇ   ‚îî‚îÄ‚îÄ patient-search.dto.go
‚îî‚îÄ‚îÄ queries/
    ‚îú‚îÄ‚îÄ patient-core.postgres.go
    ‚îî‚îÄ‚îÄ patient-search.postgres.go
```

---

## ‚úÖ CHECKLIST PR√â-IMPL√âMENTATION

- [ ] Valider format code patient avec √©quipe m√©tier
- [ ] Confirmer champs obligatoires/optionnels
- [ ] D√©finir seuils d√©tection doublons
- [ ] Valider strat√©gie de cache
- [ ] Pr√©voir migration donn√©es existantes
- [ ] D√©finir processus fusion doublons
- [ ] Configurer monitoring performances
- [ ] Pr√©parer donn√©es de test (1M+ patients)
- [ ] Documenter API pour autres modules

---

**Ces sp√©cifications garantissent un r√©f√©rentiel patient unique, performant et scalable, √©liminant les doublons tout en pr√©servant l'isolation des donn√©es m√©dicales par √©tablissement.**
