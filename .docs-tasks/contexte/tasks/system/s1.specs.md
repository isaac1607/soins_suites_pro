# SP√âCIFICATIONS TECHNIQUES SOINS SUITE - MVP

## 1. MIDDLEWARE - GESTION MULTI-TENANT & S√âCURIT√â

### üìã Informations G√©n√©rales

- **Module :** Middleware Multi-tenant & Licence
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have (Core Infrastructure)
- **Architecture :** Gin Middleware Chain

### üéØ Objectif

D√©velopper les middlewares essentiels pour :

- Validation du code √©tablissement transmis par le frontend
- V√©rification d'existence et statut de l'√©tablissement
- Contr√¥le de licence et modules autoris√©s
- Isolation multi-tenant compl√®te

### üèóÔ∏è Architecture Middleware Chain

```
Request ‚Üí CORS ‚Üí Recovery ‚Üí Logger ‚Üí
EstablishmentMiddleware ‚Üí LicenseMiddleware ‚Üí
Controller
```

### üìÅ Arborescence Middlewares

```
internal/shared/middleware/
‚îú‚îÄ‚îÄ middleware.module.go                    # Module Fx principal middlewares
‚îú‚îÄ‚îÄ authentication/
‚îÇ   ‚îú‚îÄ‚îÄ establishment.middleware.go         # EstablishmentMiddleware
‚îÇ   ‚îî‚îÄ‚îÄ license.middleware.go               # LicenseMiddleware
‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îú‚îÄ‚îÄ cors.go                            # Configuration CORS
‚îÇ   ‚îú‚îÄ‚îÄ recovery.go                        # Recovery from panics
‚îÇ   ‚îî‚îÄ‚îÄ security.go                        # Headers s√©curit√©
‚îú‚îÄ‚îÄ logging/
‚îÇ   ‚îî‚îÄ‚îÄ logger.go                          # Logger Gin principal
‚îî‚îÄ‚îÄ validation/
    ‚îî‚îÄ‚îÄ context_validator.go               # Validation contexte requests
```

### üîß MIDDLEWARE 1 : EstablishmentMiddleware

#### Responsabilit√©s

1. **Extraction code √©tablissement** depuis header `X-Establishment-Code`
2. **Validation existence** √©tablissement
3. **Contr√¥le statut** (actif/suspendu)
4. **Injection contexte** pour controllers

#### Headers Requis

```http
X-Establishment-Code: CENTREA
```

#### API Endpoints Affect√©s

**TOUS** les endpoints `/api/v1/*` sauf :

- `/health`
- `/ready`
- `/api/v1/system/ping`
- `/api/v1/system/offline/synchronised`

#### R√®gles M√©tier

- **Header obligatoire** : Tous appels API n√©cessitent `X-Establishment-Code`
- **Format strict** : Code alphanum√©rique, 3-20 caract√®res, majuscules
- **Cache optimis√©** : Cache sans expiration (donn√©es immuables : ID, app_instance, code, statut)
- **Isolation totale** : Aucune fuite de donn√©es entre √©tablissements

#### Schema Cache EstablishmentMiddleware

```
Cl√© : soins_suite_{code_etablissement}_cache_middleware:establishment
TTL : Infini (donn√©es immuables)
Donn√©es : {"id": "uuid", "app_instance": "uuid", "code": "CODE", "statut": "actif"}
```

#### R√©ponses d'Erreur - Status 460

##### Code Manquant

```json
{
  "error": "Code √©tablissement requis",
  "code": "ESTABLISHMENT_CODE_REQUIRED",
  "details": {
    "header_required": "X-Establishment-Code"
  }
}
```

##### Format Invalide

```json
{
  "error": "Format code √©tablissement invalide",
  "code": "ESTABLISHMENT_CODE_INVALID_FORMAT",
  "details": {
    "code_recu": "inv@lid",
    "format_requis": "Alphanum√©rique, 3-20 caract√®res, majuscules"
  }
}
```

##### √âtablissement Inexistant

```json
{
  "error": "√âtablissement non trouv√©",
  "code": "ESTABLISHMENT_NOT_FOUND",
  "details": {
    "establishment_code": "CENTREA"
  }
}
```

##### √âtablissement Suspendu

```json
{
  "error": "√âtablissement suspendu",
  "code": "ESTABLISHMENT_SUSPENDED",
  "details": {
    "establishment_code": "CENTREA",
    "statut": "suspendu",
    "motif": "Licence expir√©e"
  }
}
```

### üîß MIDDLEWARE 2 : LicenseMiddleware

#### Responsabilit√©s

1. **Contr√¥le licence active**
2. **V√©rification expiration** (mode online uniquement)
3. **Validation modules autoris√©s**
4. **Gestion cache licence**

#### R√®gles M√©tier

- **Licence obligatoire** : √âtablissement DOIT avoir licence active
- **Premium local** : Aucune expiration en mode local
- **Expiration online** : Contr√¥le strict en mode online
- **Modules JSONB** : Validation depuis `modules_autorises`
- **Cache 24h** : Optimisation performances pour donn√©es semi-statiques

#### Schema Cache LicenseMiddleware

```
Cl√© : soins_suite_{code_etablissement}_cache_middleware:license
TTL : 24 heures (86400s)
Donn√©es : {"id": "uuid", "type_licence": "standard", "mode_deploiement": "online",
          "statut": "actif", "modules_autorises": ["ACCUEIL", "CAISSE"],
          "date_expiration": "2026-01-15T00:00:00Z"}
```

#### R√©ponses d'Erreur - Status 465 (Licence)

##### Licence Inactive

```json
{
  "error": "Licence inactive",
  "code": "LICENSE_INACTIVE",
  "details": {
    "establishment_code": "CENTREA",
    "license_status": "revoquee"
  }
}
```

##### Licence Expir√©e

```json
{
  "error": "Licence expir√©e",
  "code": "LICENSE_EXPIRED",
  "details": {
    "establishment_code": "CENTREA",
    "expiration_date": "2025-08-15T00:00:00Z",
    "days_expired": 16
  }
}
```

##### Licence Inexistante

```json
{
  "error": "Aucune licence trouv√©e",
  "code": "LICENSE_NOT_FOUND",
  "details": {
    "establishment_code": "CENTREA"
  }
}
```

#### R√©ponses d'Erreur - Status 470 (Module)

##### Module Non Autoris√©

```json
{
  "error": "Module non autoris√© par la licence",
  "code": "MODULE_NOT_LICENSED",
  "details": {
    "establishment_code": "CENTREA",
    "module_requested": "CARDIOLOGIE",
    "modules_authorized": ["ACCUEIL", "CAISSE", "INFIRMERIE"]
  }
}
```

### üîß Structure Contexte Request

#### Gin Context Enrichi

```go
// Donn√©es inject√©es dans gin.Context
type EstablishmentContext struct {
    ID                   string `json:"id"`
    Code                 string `json:"code"`
    Nom                  string `json:"nom"`
}

type LicenseContext struct {
    ID                string   `json:"id"`
    Type              string   `json:"type"`         // premium|standard|evaluation
    Mode              string   `json:"mode"`         // local|online
    ModulesAutorises  []string `json:"modules_autorises"`
    DateExpiration    *string  `json:"date_expiration"`
    EstActive         bool     `json:"est_active"`
}

// Acc√®s dans controllers :
// establishment := c.MustGet("establishment").(EstablishmentContext)
// license := c.MustGet("license").(LicenseContext)
```

---

## 2. MODULE SYSTEM - INFORMATIONS √âTABLISSEMENT & LICENCE

### üìã Informations G√©n√©rales

- **Module :** System - Informations √âtablissement
- **Version :** 1.0 MVP
- **Priorit√© :** Must Have
- **Endpoints :** Lecture + Activation Offline

### üéØ Objectif

Fournir aux applications front-end les informations essentielles sur :

- √âtat de l'√©tablissement
- Statut et d√©tails de la licence
- Modules autoris√©s et disponibles
- Configuration syst√®me de base
- Activation et synchronisation mode offline

### üèóÔ∏è Architecture Technique MVP

```
internal/modules/system/
‚îú‚îÄ‚îÄ system.module.go              # Module Fx
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ system.controller.go      # Controller unique MVP
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ system.service.go         # Service unique MVP
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ system.dto.go             # DTOs syst√®me
‚îî‚îÄ‚îÄ queries/
    ‚îî‚îÄ‚îÄ system.postgres.go        # Requ√™tes SQL
```

### üîß API Endpoints MVP - Mode Online/Local

#### **GET /api/v1/system/info**

**Description** : Informations compl√®tes √©tablissement + licence

**Headers Requis :**

```http
X-Establishment-Code: CENTREA
```

**Response 200 :**

```json
{
  "success": true,
  "data": {
    "etablissement": {
      "id": "uuid-etablissement",
      "code": "CENTREA",
      "nom": "Centre M√©dical A",
      "nom_court": "CMA",
      "ville": "Abidjan",
      "created_at": "2025-01-15T10:00:00Z"
    },
    "licence": {
      "id": "uuid-licence",
      "type": "standard",
      "mode_deploiement": "online",
      "statut": "actif",
      "date_activation": "2025-01-15T10:00:00Z",
      "date_expiration": "2026-01-15T00:00:00Z",
      "jours_restants": 145,
      "modules_autorises": ["ACCUEIL", "CAISSE", "INFIRMERIE", "CARDIOLOGIE"]
    },
    "modules_disponibles": [
      {
        "code_module": "ACCUEIL",
        "nom_standard": "Accueil",
        "est_medical": false,
        "peut_prendre_ticket": true,
        "autorise": true,
        "est_actif": true
      },
      {
        "code_module": "CARDIOLOGIE",
        "nom_standard": "Cardiologie",
        "est_medical": true,
        "peut_prendre_ticket": true,
        "autorise": true,
        "est_actif": true
      },
      {
        "code_module": "CHIRURGIE",
        "nom_standard": "Chirurgie",
        "est_medical": true,
        "peut_prendre_ticket": true,
        "autorise": false,
        "est_actif": true
      }
    ],
    "configuration": {
      "duree_validite_ticket_jours": 15,
      "nb_souches_par_caisse": 100,
      "garde_active": true,
      "garde_heure_debut": "18:00:00",
      "garde_heure_fin": "08:00:00"
    }
  }
}
```

#### **GET /api/v1/system/modules/authorized**

**Description** : Modules autoris√©s uniquement (pour navigation dynamique)

**Headers Requis :**

```http
X-Establishment-Code: CENTREA
```

**Response 200 :**

```json
{
  "success": true,
  "data": {
    "modules_autorises": [
      {
        "code_module": "ACCUEIL",
        "nom_standard": "Accueil",
        "est_medical": false,
        "peut_prendre_ticket": true,
        "est_module_back_office": false
      },
      {
        "code_module": "CARDIOLOGIE",
        "nom_standard": "Cardiologie",
        "est_medical": true,
        "peut_prendre_ticket": true,
        "est_module_back_office": false
      }
    ]
  }
}
```

### üîß API Endpoints MVP - Mode Offline Uniquement

#### **POST /api/v1/system/activated**

**Description** : Endpoint appel√© par le back-office local pour d√©clencher la v√©rification de synchronisation

**Headers Requis :**

```http
X-Establishment-Code: CENTREA
X-Client-Type : back-office
```

**Request Body :**

```json
{
  "code_etablissement": "CENTREA"
}
```

**Response 200 :**

```json
{
  "success": true,
  "data": {
    "synchronisation_effectuee": true,
    "etablissement_existe": true,
    "message": "Synchronisation des donn√©es depuis le serveur central effectu√©e"
  }
}
```

**Response 400 :**

```json
{
  "error": "Etablissement sanitaire non trouv√© ou pas encore configur√©",
  "code": "APP_INSTANCE_NOT_FOUND",
  "details": {} // D√©tail technique pour dev
}
```

**R√®gles M√©tier Sp√©cifiques :**

- **Middleware Autoris√©** : Route utilisant le middleware EstablishmentMiddleware. `X-Establishment-Code`
- **Header Obligatoire** : S'assurer que l'en-t√™te contienne : `X-Client-Type : back-office` sinon renvoyer un code d'erreur 400
- Analyse obligatoirement le sch√©ma de la BDD : `database/schemas/00.initial.sql`
- **R√®gle m√©tier** :
  - R√©cup√©rer la variable d'environnement `APP_INSTANCE` et le code de l'√©tablissement
  - Appeler le backend en ligne √† l'endpoint POST `/api/v1/system/offline/synchronised`
  - Configurer l'URL du backend central dans le .env et le `internal/app/config.go`
  - Si status 200, r√©cup√©rer toutes les informations de l'√©tablissement, des modules disponibles, du super-admin √† ins√©rer dans la BDD respectivement (base_etablissement, base_licence, base_module, base_rubrique, base_user_utilisateur)
  - Si status diff√©rent de 200, bien g√©rer les r√©ponses avec des erreurs bien concises et pr√©cises . Prendre en compte le cas o√π la tentative d'accc√®s √† Backend en ligne est impossible.

#### **POST /api/v1/system/offline/synchronised**

**Description** : Endpoint pour synchronisation initiale des donn√©es d'√©tablissement (appel√© par serveur local vers serveur central)

**Note :** Cet endpoint ne n√©cessite PAS le header `X-Establishment-Code` car les infos sont dans le body

**Headers Requis :**

```http
X-Establishment-Code: CENTREA
```

**Request Body :**

```json
{
  "app_instance": "uuid-app-instance-etablissement"
}
```

**Response 200 - Synchronisation R√©ussie :**

```json
{
  "success": true,
  "data": {
    "etablissement": {
      "id": "uuid-etablissement",
      "app_instance": "uuid-app-instance-etablissement",
      "etablissement_code": "CENTREA",
      "nom": "Centre M√©dical A",
      "nom_court": "CMA",
      "adresse_complete": "Rue des Palmiers, Cocody",
      "ville": "Abidjan",
      "commune": "Cocody",
      "telephone_principal": "+225 01 02 03 04 05",
      "email": "contact@centremedical-a.ci",
      "duree_validite_ticket_jours": 15,
      "nb_souches_par_caisse": 100,
      "garde_heure_debut": "18:00:00",
      "garde_heure_fin": "08:00:00",
      "created_at": "2025-01-15T10:00:00Z"
    },
    "licence": {
      "id": "uuid-licence",
      "etablissement_id": "uuid-etablissement",
      "mode_deploiement": "local",
      "type_licence": "premium",
      "modules_autorises": [
        "ACCUEIL",
        "CAISSE",
        "INFIRMERIE",
        "CARDIOLOGIE",
        "CHIRURGIE"
      ], // En local, tous les modules disponibles sont accord√©es (autoris√©es) √† l'√©tablissement.
      "date_activation": "2025-01-15T10:00:00Z",
      "date_expiration": null,
      "statut": "actif",
      "sync_initial_complete": false,
      "created_at": "2025-01-15T10:00:00Z"
    },
    "modules": [
      {
        "id": "uuid-module-1",
        "numero_module": 1,
        "code_module": "ACCUEIL",
        "nom_standard": "Accueil",
        "description": "Module d'accueil et orientation des patients",
        "est_medical": false,
        "est_obligatoire": true,
        "est_actif": true,
        "est_module_back_office": false,
        "peut_prendre_ticket": true,
        "rubriques": [
          {
            "id": "uuid-rubrique-1",
            "code_rubrique": "GESTION_PATIENTS",
            "nom": "Gestion des patients",
            "description": "Cr√©ation et modification des fiches patients",
            "ordre_affichage": 1,
            "est_obligatoire": true,
            "est_actif": true
          }
        ]
      }
    ],
    "super_admin": {
      "id": "uuid-admin-tir",
      "etablissement_id": "uuid-etablissement",
      "identifiant": "admin.tir",
      "nom": "Admin",
      "prenoms": "TIR",
      "telephone": "+225 00 00 00 00",
      "password_hash": "$2a$10$hashedpassword",
      "salt": "randomsalt",
      "must_change_password": true,
      "est_admin": true,
      "type_admin": "super_admin",
      "est_admin_tir": true,
      "est_temporaire": false,
      "statut": "actif",
      "created_at": "2025-01-15T10:00:00Z"
    },
    "sync_metadata": {
      "sync_timestamp": "2025-08-31T10:00:00Z",
      "total_modules": 5,
      "total_rubriques": 15,
      "version_donnees": "1.0"
    }
  }
}
```

**Response 404 :**

```json
{
  "error": "√âtablissement ou instance non trouv√©(e)",
  "code": "ESTABLISHMENT_OR_INSTANCE_NOT_FOUND",
  "details": {
    "app_instance": "uuid-app-instance-etablissement",
    "code_etablissement": "CENTREA"
  }
}
```

**Response 409 :**

```json
{
  "error": "√âtablissement d√©j√† synchronis√©",
  "code": "ESTABLISHMENT_ALREADY_SYNCHRONIZED",
  "details": {
    "app_instance": "uuid-app-instance-etablissement",
    "code_etablissement": "CENTREA",
    "date_derniere_sync": "2025-08-25T10:00:00Z"
  }
}
```

**R√®gles M√©tier Sp√©cifiques :**

- **Middleware Autoris√©** : Route utilisant le middleware EstablishmentMiddleware, LicenceMiddleware.
- Analyse obligatoirement le sch√©ma de la BDD : `database/schemas/00.initial.sql`
- **R√®gle m√©tier** :
  - V√©rifier que les champs `sync_initial_complete` et `date_sync_initial` de la table `base_licence` sont √† false et null respectivement sinon renvoy√© le code d'erreur 409 comme sp√©cifi√© dans le format de la r√©ponse.
  - V√©rifier que app_instance existe dans base_etablissement et concorde bien avec le code de l'√©tablissement. Sinon renvoyer un code d'erreur 404.
  - Si oui r√©cup√©rer les informations de l'√©tablissement,licences, des modules disponibles, du super-admin(base_etablissement, base_licence, base_module, base_rubrique, base_user_utilisateur) comme sp√©cifi√© dans le format de la r√©ponse.
  - Mettre les champs `sync_initial_complete` et `date_sync_initial` dans la table `base_licence` respectivement √† true, date en cours
  - Retourner la r√©ponse statut 200

### üîß R√®gles M√©tier MVP

#### Validation Licence

- **Premium Local** : Pas d'expiration (date_expiration = NULL)
- **Standard/Evaluation** : Expiration obligatoire
- **Mode Online** : Contr√¥le expiration syst√©matique
- **Modules JSONB** : Intersection avec modules disponibles

#### R√®gles Synchronisation Offline

- **App Instance Unique** : V√©rification `app_instance` + `code_etablissement` dans `base_etablissement`
- **Sync Unique** : Un √©tablissement ne peut √™tre synchronis√© qu'une seule fois (flag `sync_initial_complete`)
- **Donn√©es Compl√®tes** : Retour de TOUTES les donn√©es n√©cessaires
- **Modules avec Rubriques** : Structure compl√®te pour permissions
- **Super Admin TIR** : Compte administrateur cr√©√© automatiquement

#### Cache Strategy

- **System Info** : Cache 15 minutes
- **Licence Status** : Cache 5 minutes
- **Modules** : Cache 1 heure
- **Sync Data** : Pas de cache (donn√©es critiques)

### üîß M√©thodes Service MVP

```go
type SystemService interface {
    GetSystemInfo(ctx context.Context) (*SystemInfoResponse, error)
    GetLicenseStatus(ctx context.Context) (*LicenseStatusResponse, error)
    GetAuthorizedModules(ctx context.Context) (*AuthorizedModulesResponse, error)
    ActivateOfflineSystem(ctx context.Context, req *ActivateOfflineRequest) (*ActivateOfflineResponse, error)
    SynchronizeOfflineData(ctx context.Context, req *SyncOfflineRequest) (*SyncOfflineResponse, error)
    ValidateModuleAccess(ctx context.Context, moduleCode string) error
}
```

#### M√©thodes Core

- `GetSystemInfo` : Informations compl√®tes (√©tablissement + licence + modules + config)
- `GetLicenseStatus` : Statut licence avec alertes
- `GetAuthorizedModules` : Modules autoris√©s pour navigation
- `ActivateOfflineSystem` : D√©clenchement synchronisation pour d√©ploiement local
- `SynchronizeOfflineData` : Transfert complet donn√©es √©tablissement
- `ValidateAppInstance` : V√©rification app_instance + code_etablissement
- `CheckSyncStatus` : Contr√¥le statut synchronisation
- `BuildCompleteEstablishmentData` : Construction dataset complet pour sync
- `ValidateModuleAccess` : Validation ponctuelle acc√®s module
- `CheckLicenseExpiry` : Contr√¥le expiration avec seuils d'alerte

---

## 3. INT√âGRATION FRONT-END

### üîß Pattern d'Appels API

#### Extraction Code √âtablissement (JavaScript)

```javascript
// utils/establishment.js
export function getEstablishmentCode() {
  const hostname = window.location.hostname;

  // Pattern: [code].back-office.soins-suite.tir.ci
  // ou: [code].soins-suite.tir.ci
  const parts = hostname.split(".");

  if (parts.length >= 3 && parts[0] !== "back-office" && parts[0] !== "www") {
    return parts[0].toUpperCase();
  }

  throw new Error("Code √©tablissement non trouv√© dans le sous-domaine");
}
```

#### Configuration Axios

```javascript
// api/client.js
import axios from "axios";
import { getEstablishmentCode } from "../utils/establishment";

const apiClient = axios.create({
  baseURL: "https://api.soins-suite.tir.ci/api/v1",
  timeout: 30000,
});

// Intercepteur pour ajouter le code √©tablissement
apiClient.interceptors.request.use((config) => {
  try {
    const establishmentCode = getEstablishmentCode();
    config.headers["X-Establishment-Code"] = establishmentCode;
    return config;
  } catch (error) {
    return Promise.reject(new Error("Configuration sous-domaine invalide"));
  }
});
```

### üîß Gestion Erreurs Front-End

#### Gestion Status Codes Sp√©cifiques

```javascript
// hooks/useSystemInfo.js
export function useSystemInfo() {
  const { data, error } = useSWR("/system/info", fetcher);

  // Gestion erreurs middleware
  if (error?.response?.status === 460) {
    // Erreur √©tablissement
    handleEstablishmentError(error.response.data);
  } else if (error?.response?.status === 465) {
    // Erreur licence
    handleLicenseError(error.response.data);
  } else if (error?.response?.status === 470) {
    // Erreur module
    handleModuleError(error.response.data);
  }

  return { systemInfo: data?.data, loading: !data && !error, error };
}
```

---

## 4. D√âPLOIEMENT MVP

### üîß Variables Environnement

```bash
# Backend Go
APP_ENV=development
DB_HOST=localhost
DB_NAME=soins_suite
REDIS_HOST=localhost

# Django Admin
DJANGO_DB_MAIN_HOST=localhost
DJANGO_DB_MAIN_NAME=soins_suite

# Serveur Central (pour sync offline)
CENTRAL_SERVER_URL=https://api.soins-suite.tir.ci

# DNS/Sous-domaines (Dev)
CORS_ALLOWED_ORIGINS="*.soins-suite.tir.ci,localhost:3000"
```

### üîß Configuration DNS

```dns
# Production
*.soins-suite.tir.ci          ‚Üí Frontend App
*.back-office.soins-suite.tir.ci ‚Üí Backend App
api.soins-suite.tir.ci        ‚Üí API Backend Go

# D√©veloppement
*.localhost:3000              ‚Üí Frontend Dev
api.localhost:4000            ‚Üí Backend Dev Go
admin.localhost:8000          ‚Üí Django Admin
```

### üîß Flow Activation Offline

```mermaid
sequenceDiagram
    participant LocalFE as App Local (Frontend)
    participant LocalBE as Backend Local
    participant CentralBE as Backend Central
    participant LocalDB as DB Local

    LocalFE->>LocalBE: POST /system/activated
    LocalBE->>CentralBE: POST /system/offline/synchronised
    CentralBE->>CentralBE: Validation app_instance + code
    CentralBE-->>LocalBE: Donn√©es compl√®tes √©tablissement
    LocalBE->>LocalDB: Insertion donn√©es re√ßues
    LocalBE-->>LocalFE: Confirmation synchronisation
```

Ce MVP couvre les fonctionnalit√©s essentielles pour d√©marrer avec un syst√®me multi-tenant s√©curis√©, incluant la synchronisation offline, tout en gardant la simplicit√© requise pour un d√©veloppement rapide.
